(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-14f455b3","chunk-c673cd1a"],{"159b":function(t,e,r){"use strict";var a=r("cfe9"),o=r("fdbc"),i=r("785a"),s=r("17c2"),n=r("9112"),l=function(t){if(t&&t.forEach!==s)try{n(t,"forEach",s)}catch(e){t.forEach=s}};for(var d in o)o[d]&&l(a[d]&&a[d].prototype);l(i)},"17c2":function(t,e,r){"use strict";var a=r("b727").forEach,o=r("a640"),i=o("forEach");t.exports=i?[].forEach:function(t){return a(this,t,arguments.length>1?arguments[1]:void 0)}},"410b":function(t,e,r){"use strict";r("b8ea")},"688a":function(t,e,r){},"6ec4":function(t,e,r){"use strict";r("688a")},a15b:function(t,e,r){"use strict";var a=r("23e7"),o=r("e330"),i=r("44ad"),s=r("fc6a"),n=r("a640"),l=o([].join),d=i!==Object,c=d||!n("join",",");a({target:"Array",proto:!0,forced:c},{join:function(t){return l(s(this),void 0===t?",":t)}})},a640:function(t,e,r){"use strict";var a=r("d039");t.exports=function(t,e){var r=[][t];return!!r&&a((function(){r.call(null,e||function(){return 1},1)}))}},b8ea:function(t,e,r){},d7e3:function(t,e,r){"use strict";r.r(e);var a=function(){var t=this,e=t._self._c;return e("div",[e("codemirror",{attrs:{options:t.options},model:{value:t.rowData,callback:function(e){t.rowData=e},expression:"rowData"}})],1)},o=[],i=r("8f94"),s=(r("0f7c"),r("ffda"),{name:"conflictRowsLogDetail",props:{rowData:String},components:{codemirror:i["codemirror"]},data:function(){return{options:{value:"",mode:"text/x-mysql",theme:"ambiance",lineWrapping:!0,height:100,readOnly:!0,lineNumbers:!0}}}}),n=s,l=(r("6ec4"),r("2877")),d=Object(l["a"])(n,a,o,!1,null,null,null);e["default"]=d.exports},ece4:function(t,e,r){"use strict";r.r(e);var a=function(){var t=this,e=t._self._c;return e("base-component",{attrs:{isFather:t.isFather,subMenuName:["1"],fatherMenu:t.fatherMenu}},[e("Breadcrumb",{style:{margin:"15px 0 15px 185px",position:"fixed"}},[e("BreadcrumbItem",{attrs:{to:"/conflictLog"}},[t._v("冲突行")]),e("BreadcrumbItem",{attrs:{to:"/conflictApproval"}},[t._v("冲突审批")]),e("BreadcrumbItem",[t._v("冲突详情")])],1),e("Content",{staticClass:"content",style:{padding:"10px",background:"#fff",margin:"50px 0 1px 185px",zIndex:"1"}},[e("div",{style:{padding:"1px 1px",height:"100%"}},[e("Card",[e("p",{attrs:{slot:"title"},slot:"title"},[t._v(" 自动冲突处理结果 ")]),"0"===t.queryType?e("div",{staticClass:"ivu-list-item-meta-title"},[t._v("事务提交结果： "),e("Button",{attrs:{loading:t.logTableLoading,size:"small",type:0==t.trxLog.trxResult?"success":"error"}},[t._v(" "+t._s(t.trxLog.trxResultStr)+" ")])],1):t._e(),e("div",{staticClass:"ivu-list-item-meta-title"},[t._v("所有机房当前冲突行记录： "),e("Tooltip",{attrs:{content:"数据一致性比对忽略字段过滤的列"}},[e("Button",{attrs:{loading:t.recordLoading,size:"small",type:1==t.trxLog.recordEqual?"success":"warning"},on:{click:t.getRecords}},[t._v(t._s(t.trxLog.diffStr))])],1)],1),e("Divider"),e("div",{staticClass:"ivu-list-item-meta-title"},[t._v("源机房("+t._s(t.trxLog.srcRegion)+")")]),t._l(t.srcRecords,(function(r,a){return e("Card",{key:a},[e("div",{staticClass:"ivu-list-item-meta-title"},[t._v("表名："+t._s(r.tableName)+" "),e("Tooltip",{attrs:{content:1==r.doubleSync?"双向同步":"单向同步"}},[e("Button",{attrs:{size:"small",type:1==r.doubleSync?"success":"primary"}},[t._v(" "+t._s(1==r.doubleSync?"双向同步":"单向同步")+" ")])],1)],1),e("Table",{attrs:{size:"small",columns:r.columns,data:r.records,border:""}})],1)})),e("Divider"),e("div",{staticClass:"ivu-list-item-meta-title"},[t._v("目标机房("+t._s(t.trxLog.dstRegion)+")")]),t._l(t.dstRecords,(function(r,a){return e("Card",{key:a},[e("div",{staticClass:"ivu-list-item-meta-title"},[t._v("表名："+t._s(r.tableName)+" "),e("Tooltip",{attrs:{content:1==r.doubleSync?"双向同步":"单向同步"}},[e("Button",{attrs:{size:"small",type:1==r.doubleSync?"success":"primary"}},[t._v(" "+t._s(1==r.doubleSync?"双向同步":"单向同步")+" ")])],1)],1),e("Table",{attrs:{size:"small",columns:r.columns,data:r.records,border:""}})],1)}))],2),e("Divider"),e("Card",[e("p",{attrs:{slot:"title"},slot:"title"},[t._v(" DRC冲突处理流程 ")]),e("Table",{ref:"multipleTable",attrs:{stripe:"",loading:t.logTableLoading,columns:t.trxLog.columns,data:t.dataWithPage},on:{"on-selection-change":t.changeSelection}}),e("div",[e("Page",{attrs:{transfer:!0,total:t.trxLog.tableData.length,current:t.trxLog.current,"page-size-opts":t.trxLog.pageSizeOpts,"page-size":this.trxLog.size,"show-total":"","show-sizer":"","show-elevator":""},on:{"update:current":function(e){return t.$set(t.trxLog,"current",e)},"on-page-size-change":t.handleChangeSize}})],1)],1),e("Divider"),e("Card",[e("p",{attrs:{slot:"title"},slot:"title"},[t._v(" 选择冲突行自动冲突处理 ")]),e("p",[t._v("写入region")]),e("Row",{attrs:{gutter:10}},[e("Col",{attrs:{span:"3"}},[e("Select",{attrs:{filterable:"",clearable:"",placeholder:"选择写入region"},model:{value:t.writeSide,callback:function(e){t.writeSide=e},expression:"writeSide"}},t._l(t.regionOpt,(function(r){return e("Option",{key:r.key,attrs:{value:r.key}},[t._v(t._s(r.val))])})),1)],1),e("Col",{attrs:{span:"4"}},["2"!==t.queryType?e("Button",{attrs:{loading:t.sqlLoading,size:"middle",type:"success"},on:{click:t.generateHandleSql}},[t._v("生成SQL")]):t._e()],1),e("Col",{attrs:{span:"4"}},["2"===t.queryType?e("a",{attrs:{target:"_blank",href:this.approvalDetailUrl}},[t._v("审批链接")]):t._e()])],1),e("br"),e("div",{attrs:{loading:t.sqlLoading}},[e("codemirror",{attrs:{options:t.options},model:{value:t.handleSql,callback:function(e){t.handleSql=e},expression:"handleSql"}})],1),e("br"),"2"!==t.queryType?e("Button",{attrs:{loading:t.approvalLoading,size:"middle",type:"primary"},on:{click:t.generateApproval}},[t._v("提交审批")]):t._e(),t.showExecute?e("Button",{attrs:{disabled:"true"===t.disabled,loading:t.executeLoading,size:"middle",type:"primary"},on:{click:t.executeApproval}},[t._v("执行SQL")]):t._e()],1),e("Divider")],1)])],1)},o=[],i=r("2909"),s=(r("a15b"),r("14d9"),r("fb6a"),r("d3b7"),r("159b"),r("d7e3")),n=r("8f94"),l=(r("0f7c"),r("ffda"),{name:"conflictLogDetail",props:{rowData:String},components:{codemirror:n["codemirror"]},data:function(){return{disabled:"",executeLoading:!1,showExecute:!1,approvalDetailUrl:"",approvalLoading:!1,handleSql:"",handleSqlList:[],showHandleSql:!1,multiData:[],sqlLoading:!1,writeSide:0,regionOpt:[],queryType:0,byRowLogIds:!1,rowLogIds:[],conflictTrxLogId:0,recordLoading:!1,logTableLoading:!1,approvalId:0,srcRecords:[],dstRecords:[],srcTable:{data:[],columns:[]},dstTable:{data:[],columns:[]},trxLog:{srcRegion:"",dstRegion:"",trxResult:null,trxResultStr:"",hasDiff:null,recordEqual:null,diffStr:"",tableData:[],columns:[{type:"selection",width:40,align:"center"},{type:"expand",width:40,render:function(t,e){var r=e.row;return t(s["default"],{props:{rowData:"/*原始SQL*/\n"+r.rawSql+"\n/*原始SQL处理结果: "+r.rawSqlResult+"*/\n\n/*冲突时行记录*/\n"+r.dstRowRecord+"\n\n/*冲突处理SQL*/\n"+r.handleSql+"\n/*冲突处理SQL处理结果: "+r.handleSqlResult+"*/"}})}},{title:"执行顺序",key:"rowId",width:100},{title:"表名",key:"tableName",width:250,tooltip:!0,render:function(t,e){var r=e.row,a=r.dbName+"."+r.tableName;return t("div",a)}},{title:"原始sql",key:"rawSql",tooltip:!0},{title:"处理结果",key:"rowResult",width:120,align:"center",render:function(t,e){var r=e.row,a=0===r.rowResult?"blue":"volcano",o=0===r.rowResult?"commit":"rollback";return t("Tag",{props:{color:a}},o)}}],total:0,current:1,size:10,pageSizeOpts:[10,20,50,100]},options:{value:"",mode:"text/x-mysql",theme:"ambiance",lineWrapping:!0,height:100,readOnly:!0,lineNumbers:!0}}},methods:{executeApproval:function(){var t=this;this.executeLoading=!0,this.axios.post("/api/drc/v2/log/approval/execute?approvalId="+this.approvalId).then((function(e){1===e.data.status?t.$Message.error("SQL执行失败! "+e.data.message):(t.$Message.success("SQL执行成功!"),t.disabled="true",t.getRecords())})).finally((function(){t.executeLoading=!1}))},getHandleSql:function(){var t=this;this.axios.get("/api/drc/v2/log/approval/detail?approvalId="+this.approvalId).then((function(e){if(1===e.data.status)t.$Message.error("查询冲突自动处理SQL失败!");else{var r=e.data;t.handleSqlList=r.data;var a=[];r.data.forEach((function(t){return a.push(t.autoHandleSql)})),t.handleSql=a.join("\n")}})).finally((function(){t.logTableLoading=!1}))},generateApproval:function(){var t=this;if(0!==this.handleSqlList.length){this.approvalLoading=!0;var e=[];this.handleSqlList.forEach((function(t){var r={rowLogId:t.rowLogId,handleSql:t.autoHandleSql};e.push(r)})),this.axios.post("/api/drc/v2/log/approval/create",{writeSide:this.writeSide,handleSqlDtos:e}).then((function(e){1===e.data.status?t.$Message.error("提交审批单失败！"):t.$Message.success("提交审批单成功")})).finally((function(){t.approvalLoading=!1}))}else this.$Message.warning("未生成SQL！")},generateHandleSql:function(){var t=this,e=this.multiData;if(void 0!==e&&null!==e&&0!==e.length){var r=[];e.forEach((function(t){return r.push(t.rowLogId)})),this.sqlLoading=!0,this.handleSql="",this.axios.post("/api/drc/v2/log/conflict/rows/handleSql",{writeSide:this.writeSide,rowLogIds:r}).then((function(e){var r=e.data;if(0===r.status){t.handleSqlList=r.data;var a=[];r.data.forEach((function(t){return a.push(t.autoHandleSql)})),t.handleSql=a.join("\n")}else t.$Message.error("自动生成SQL失败: "+r.message)})).finally((function(){t.sqlLoading=!1}))}else this.$Message.warning("请勾选！")},handleSpan:function(t){t.row,t.column,t.rowIndex;var e=t.columnIndex;if(0===e)return[0,0]},handleChangeSize:function(t){this.trxLog.size=t},getTrxLogDetail:function(){var t=this;this.logTableLoading=!0,this.axios.get("/api/drc/v2/log/conflict/detail?conflictTrxLogId="+this.conflictTrxLogId).then((function(e){if(1===e.data.status)t.$Message.error("查询冲突详情失败!");else{var r=e.data.data;t.trxLog.srcRegion=r.srcRegion,t.trxLog.dstRegion=r.dstRegion,t.trxLog.trxResult=r.trxResult,t.trxLog.trxResultStr=0===r.trxResult?"commit":"rollback",t.trxLog.tableData=r.rowsLogDetailViews,t.regionOpt=[{key:0,val:t.trxLog.dstRegion},{key:1,val:t.trxLog.srcRegion}]}})).finally((function(){t.logTableLoading=!1}))},getTrxLogDetail1:function(){var t=this;this.logTableLoading=!0,this.axios.get("/api/drc/v2/log/conflict/rows/detail?conflictRowLogIds="+this.rowLogIds).then((function(e){if(1===e.data.status)t.$Message.error("查询冲突详情失败!");else{var r=e.data.data;t.trxLog.srcRegion=r.srcRegion,t.trxLog.dstRegion=r.dstRegion,t.trxLog.trxResult=r.trxResult,t.trxLog.trxResultStr=0===r.trxResult?"commit":"rollback",t.trxLog.tableData=r.rowsLogDetailViews,t.regionOpt=[{key:0,val:t.trxLog.dstRegion},{key:1,val:t.trxLog.srcRegion}]}})).finally((function(){t.logTableLoading=!1}))},getTrxLogDetail2:function(){var t=this;this.logTableLoading=!0,this.axios.get("/api/drc/v2/log/approval/rows/detail?approvalId="+this.approvalId).then((function(e){if(1===e.data.status)t.$Message.error("查询冲突详情失败!");else{var r=e.data.data;t.trxLog.srcRegion=r.srcRegion,t.trxLog.dstRegion=r.dstRegion,t.trxLog.trxResult=r.trxResult,t.trxLog.trxResultStr=0===r.trxResult?"commit":"rollback",t.trxLog.tableData=r.rowsLogDetailViews,t.regionOpt=[{key:0,val:t.trxLog.dstRegion},{key:1,val:t.trxLog.srcRegion}]}})).finally((function(){t.logTableLoading=!1}))},getWriteSide:function(){var t=this;this.axios.get("/api/drc/v2/log/approval/writeSide?approvalId="+this.approvalId).then((function(e){1===e.data.status?t.$Message.error("查询写入region失败!"):t.writeSide=e.data.data}))},getTrxRecords:function(){var t=this;this.recordLoading=!0,this.axios.get("/api/drc/v2/log/conflict/records?conflictTrxLogId="+this.conflictTrxLogId+"&columnSize=12").then((function(e){if(1===e.data.status)t.trxLog.diffStr="数据比对失败";else{var r=e.data.data;t.trxLog.recordEqual=r.recordIsEqual,t.trxLog.diffStr=r.recordIsEqual?"数据一致":"数据不一致",t.srcRecords=r.srcRecords,t.dstRecords=r.dstRecords}})).finally((function(){t.recordLoading=!1}))},getTrxRecords1:function(){var t=this;this.recordLoading=!0,this.axios.get("/api/drc/v2/log/conflict/rows/records?conflictRowLogIds="+this.rowLogIds).then((function(e){if(1===e.data.status)t.trxLog.diffStr="数据比对失败";else{var r=e.data.data;t.trxLog.recordEqual=r.recordIsEqual,t.trxLog.diffStr=r.recordIsEqual?"数据一致":"数据不一致",t.srcRecords=r.srcRecords,t.dstRecords=r.dstRecords}})).finally((function(){t.recordLoading=!1}))},getTrxRecords2:function(){var t=this;this.recordLoading=!0,this.axios.get("/api/drc/v2/log/approval/rows/records?approvalId="+this.approvalId).then((function(e){if(1===e.data.status)t.trxLog.diffStr="数据比对失败";else{var r=e.data.data;t.trxLog.recordEqual=r.recordIsEqual,t.trxLog.diffStr=r.recordIsEqual?"数据一致":"数据不一致",t.srcRecords=r.srcRecords,t.dstRecords=r.dstRecords}})).finally((function(){t.recordLoading=!1}))},getRecords:function(){"0"===this.queryType?this.getTrxRecords():"1"===this.queryType?this.getTrxRecords1():"2"===this.queryType&&this.getTrxRecords2()},changeSelection:function(t){this.multiData=t}},computed:{dataWithPage:function(){var t=this.trxLog.tableData,e=this.trxLog.current*this.trxLog.size-this.trxLog.size,r=e+this.trxLog.size;return Object(i["a"])(t).slice(e,r)}},created:function(){this.conflictTrxLogId=this.$route.query.conflictTrxLogId,this.queryType=this.$route.query.queryType,this.approvalDetailUrl=this.$route.query.approvalDetailUrl,this.rowLogIds=this.$route.query.rowLogIds,this.approvalId=this.$route.query.approvalId,"0"===this.queryType?(this.getTrxLogDetail(),this.getTrxRecords()):"1"===this.queryType?(this.getTrxLogDetail1(),this.getTrxRecords1()):"2"===this.queryType&&(this.showExecute=this.$route.query.showExecute,this.disabled=this.$route.query.disabled,this.getWriteSide(),this.getTrxLogDetail2(),this.getTrxRecords2(),this.getHandleSql())}}),d=l,c=(r("410b"),r("2877")),u=Object(c["a"])(d,a,o,!1,null,null,null);e["default"]=u.exports}}]);
//# sourceMappingURL=chunk-14f455b3.cd318da5.js.map