(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-3f79e392"],{"4fadc":function(t,a,e){"use strict";var i=e("23e7"),n=e("6f53").entries;i({target:"Object",stat:!0},{entries:function(t){return n(t)}})},"6f53":function(t,a,e){"use strict";var i=e("83ab"),n=e("d039"),r=e("e330"),s=e("e163"),o=e("df75"),l=e("fc6a"),c=e("d1e7").f,d=r(c),p=r([].push),u=i&&n((function(){var t=Object.create(null);return t[2]=2,!d(t,2)})),h=function(t){return function(a){var e,n=l(a),r=o(n),c=u&&null===s(n),h=r.length,g=0,f=[];while(h>g)e=r[g++],i&&!(c?e in n:d(n,e))||p(f,t?[e,n[e]]:n[e]);return f}};t.exports={entries:h(!0),values:h(!1)}},"9bf1":function(t,a,e){"use strict";e.r(a);var i=function(){var t=this,a=t._self._c;return a("base-component",[a("Breadcrumb",{style:{margin:"15px 0 15px 185px",position:"fixed"}},[a("BreadcrumbItem",{attrs:{to:{path:"/v2/mhaReplications",query:{srcMhaName:this.initInfo.srcMhaName,dstMhaName:this.initInfo.dstMhaName,preciseSearchMode:!0}}}},[t._v("首页 ")]),a("BreadcrumbItem",{attrs:{to:{path:"/drcV2",query:{step:3,srcMhaName:this.initInfo.srcMhaName,dstMhaName:this.initInfo.dstMhaName,srcDc:this.initInfo.srcDc,dstDc:this.initInfo.dstDc,order:this.initInfo.order}}}},[t._v("DRC配置V2 ")]),a("BreadcrumbItem",[t._v("同步表")])],1),a("Content",{staticClass:"content",style:{padding:"10px",background:"#fff",margin:"50px 0 1px 185px",zIndex:"1"}},[a("Row",[a("Col",{attrs:{span:"8"}},[a("span",{staticStyle:{"margin-top":"10px",color:"#464c5b","font-weight":"600"}},[t._v(t._s(t.initInfo.srcMhaName)+"("+t._s(t.initInfo.srcDc)+")==>"+t._s(t.initInfo.dstMhaName)+"("+t._s(t.initInfo.dstDc)+")")])]),a("Col",{attrs:{span:"2"}},[t.submitted?t._e():a("Button",{staticStyle:{"margin-top":"10px","text-align":"right"},attrs:{loading:t.dataLoading,type:"primary",ghost:""},on:{click:function(a){return t.preBatchUpdate()}}},[t._v("批量修改 ")])],1),a("Col",{attrs:{span:"4"}},[t.submitted?t._e():a("Button",{staticStyle:{"margin-top":"10px","text-align":"right"},attrs:{loading:t.dataLoading,type:"primary",ghost:""},on:{click:function(a){return t.fillMhaApplier()}}},[t._v("一键录入 mha applier ")])],1),a("Col",{attrs:{span:"4"}},[t.submitted?t._e():a("Button",{staticStyle:{"margin-top":"10px","text-align":"right"},attrs:{loading:t.dataLoading,type:"primary",ghost:""},on:{click:function(a){return t.preClearAndUpdateMhaGtid()}}},[t._v("一键回滚 ")])],1)],1),a("div",{style:{padding:"1px 1px",height:"100%"}},[[a("Table",{ref:"multipleTable",staticStyle:{"margin-top":"20px"},attrs:{stripe:"",columns:t.columns,data:t.tableData,loading:t.dataLoading,border:""},on:{"on-selection-change":t.changeSelection},scopedSlots:t._u([{key:"applier",fn:function(e){var i=e.row,n=e.index;return[a("Select",{staticStyle:{width:"250px"},attrs:{transfer:!0,multiple:"",placeholder:"选择源集群Applier"},model:{value:t.tableData[n].ips,callback:function(a){t.$set(t.tableData[n],"ips",a)},expression:"tableData[index].ips"}},t._l(t.applierResourceList,(function(e){return a("Option",{key:e.ip,attrs:{value:e.ip}},[t._v(t._s(e.ip)+" —— "+t._s(e.az)+" ")])})),1),a("Button",{staticStyle:{"margin-left":"10px"},attrs:{loading:t.applierDataLoading[n],type:"success",size:"small"},on:{click:function(a){return t.autoConfigApplier(i,n)}}},[t._v("自动录入 ")])]}},{key:"gtidInit",fn:function(e){e.row;var i=e.index;return[a("Input",{staticStyle:{width:"80%"},attrs:{border:!1,placeholder:"请输入binlog拉取位点"},model:{value:t.tableData[i].gtidInit,callback:function(a){t.$set(t.tableData[i],"gtidInit",a)},expression:"tableData[index].gtidInit"}})]}},{key:"concurrency",fn:function(e){e.row;var i=e.index;return[a("InputNumber",{staticStyle:{width:"90%"},attrs:{max:150,min:1,placeholder:""},model:{value:t.tableData[i].concurrency,callback:function(a){t.$set(t.tableData[i],"concurrency",a)},expression:"tableData[index].concurrency"}})]}}])}),t.submitted?t._e():a("Button",{staticStyle:{"margin-top":"10px","text-align":"right"},attrs:{loading:t.dataLoading,type:"primary"},on:{click:function(a){return t.preSubmit()}}},[t._v("提交 ")]),a("Modal",{attrs:{title:"请设置 Applier",width:"1200px"},on:{"on-ok":t.batchUpdateAppliers},model:{value:t.batchUpdateModal,callback:function(a){t.batchUpdateModal=a},expression:"batchUpdateModal"}},[a("div",{style:{padding:"1px 1px",height:"100%"}},[a("Form",{attrs:{"label-position":"left","label-width":100}},[a("FormItem",{attrs:{label:"Applier"}},[a("Select",{staticStyle:{width:"250px"},attrs:{transfer:!0,multiple:"",placeholder:"选择源集群Applier"},model:{value:t.target.ips,callback:function(a){t.$set(t.target,"ips",a)},expression:"target.ips"}},t._l(t.applierResourceList,(function(e){return a("Option",{key:e.ip,attrs:{value:e.ip}},[t._v(t._s(e.ip)+" —— "+t._s(e.az)+" ")])})),1)],1),a("FormItem",{attrs:{label:"初始同步位点"}},[a("Input",{staticStyle:{width:"80%"},attrs:{border:!1,placeholder:"请输入binlog拉取位点"},model:{value:t.target.gtid,callback:function(a){t.$set(t.target,"gtid",a)},expression:"target.gtid"}})],1)],1),a("p",[a("span",[t._v("共 ")]),a("span",{staticStyle:{color:"red","font-size":"16px","word-break":"break-all","word-wrap":"break-word"}},[t._v(t._s(this.updateData.length))]),a("span",[t._v(" 行数据")])]),[a("Table",{staticStyle:{"margin-top":"20px"},attrs:{stripe:"",columns:t.updateColumns,data:t.updateData,border:""}})]],2)]),a("Modal",{attrs:{title:"回滚至 MHA 同步",width:"1200px"},on:{"on-ok":t.clearAndUpdateMhaGtid},model:{value:t.rollbackModal,callback:function(a){t.rollbackModal=a},expression:"rollbackModal"}},[a("div",{style:{padding:"1px 1px",height:"100%"}},[a("p",[a("span",{staticStyle:{color:"red","font-size":"16px","word-break":"break-all","word-wrap":"break-word"}},[t._v("你正在进行回滚操作，将更新mha位点，并清空所有 db applier！")])]),a("Divider"),a("Form",{staticStyle:{width:"80%"}},[a("FormItem",{attrs:{label:"当前 DB 同步位点"}},[[a("Table",{staticStyle:{"margin-top":"20px"},attrs:{stripe:"",columns:t.dbGtidColumns,data:t.gtidCheck.dbApplied,border:""}})]],2),a("FormItem",{attrs:{label:"当前 Mha 同步位点"}},[a("Input",{attrs:{autosize:{minRows:1,maxRows:30},readonly:""},model:{value:t.gtidCheck.mhaApplied,callback:function(a){t.$set(t.gtidCheck,"mhaApplied",a)},expression:"gtidCheck.mhaApplied"}})],1),a("FormItem",{attrs:{label:"回滚后，Mha 初始同步位点将被设置为："}},[a("Input",{attrs:{type:"textarea",autosize:{minRows:1,maxRows:30},readonly:""},model:{value:t.gtidCheck.mhaTarget,callback:function(a){t.$set(t.gtidCheck,"mhaTarget",a)},expression:"gtidCheck.mhaTarget"}})],1)],1)],1)])]],2)],1)],1)},n=[],r=e("3835"),s=e("c7eb"),o=e("1da1"),l=e("53ca"),c=(e("caad"),e("a15b"),e("d81d"),e("14d9"),e("4fadc"),e("d3b7"),e("2532"),e("3ca3"),e("159b"),e("ddb0"),e("2b0e")),d={name:"tables",data:function(){var t=this;return{initInfo:{srcMhaName:"",srcMhaId:0,dstMhaName:"",dbReplicationId:0,multiData:[],srcDc:"",dstDc:"",order:!0},dataLoading:!1,applierDataLoading:[],submitted:!1,applierResourceList:[],batchUpdateModal:!1,rollbackModal:!1,gtidCheck:{mhaApplied:"",dbApplied:[],mhaTarget:""},mhaApplierInitGtid:null,deleteData:[],filters:[],filterMap:{0:"行过滤",1:"字段过滤"},target:{gtid:"",ips:[]},columns:[{type:"selection",width:60,align:"center"},{title:"库名",key:"dbName",width:200},{title:"Applier",slot:"applier",width:400,renderHeader:function(a,e){return a("span",[a("span","Applier 配置 -- "),a("Button",{props:{type:"success",size:"small"},on:{click:function(){t.batchAutoConfigure()}}},"自动录入")])},filters:[{label:"空",value:null},{label:"非空",value:"not null"}],filterMultiple:!1,filterMethod:function(t,a){return t?a.ips&&a.ips.length>0:!a.ips||0===a.ips.length}},{title:"初始同步位点",slot:"gtidInit"},{title:"并发数",width:200,slot:"concurrency"}],updateColumns:[{title:"库名",key:"dbName",width:200},{title:"applier 配置",key:"applier",width:300,render:function(t,a){var e=a.row,i=e.ips;return null===i||0===i.length?t("Tag",{props:{color:"blue"}},"无"):t("span",e.ips.join(", "))}},{title:"初始同步位点",key:"gtidInit",render:function(t,a){var e=a.row,i=e.gtidInit;return null===i||0===i.length?t("Tag",{props:{color:"blue"}},"无"):t("span",i)}}],dbGtidColumns:[{title:"库名",key:"dbName",width:200},{title:"当前同步位点",key:"gtidInit",render:function(t,a){var e=a.row,i=e.gtidInit;return null===i||0===i.length?t("Tag",{props:{color:"blue"}},"无"):t("span",i)}}],updateData:[],propertiesJson:{},tableData:[],total:0,size:5,pageSizeOpts:[5,10,20,100]}},methods:{getFilterText:function(t){},changeSelection:function(t){this.initInfo.multiData=t,console.log(this.initInfo.multiData)},flattenObj:function(t){var a={};for(var e in t)if("object"!==Object(l["a"])(t[e])||Array.isArray(t[e]))a[e]=t[e];else{var i=this.flattenObj(t[e]);for(var n in i)a[e+"."+n]=i[n]}return a},getFilteredData:function(){return this.$refs.multipleTable.makeDataWithSortAndFilter()},autoConfigApplier:function(t,a){var e=this;c["default"].set(this.applierDataLoading,a,!0),this.axios.get("/api/drc/v2/resource/db/auto",{params:{dstMhaName:this.initInfo.dstMhaName,type:1,selectedIps:t.ips?t.ips.join(","):null}}).then((function(i){t.ips=[],i.data.data.forEach((function(a){return t.ips.push(a.ip)})),c["default"].set(e.tableData,a,t)})).catch((function(t){e.$Message.error("提交异常: "+t)})).finally((function(){e.applierDataLoading[a]=!1}))},preSubmit:function(){var t=this;this.$Modal.confirm({title:"提交确认",content:"您确定要提交么？",onOk:function(){t.submitDbAppliers()}})},submitDbAppliers:function(){var t=this,a={srcBuildParam:{mhaName:this.initInfo.srcMhaName,dbApplierDtos:[]},dstBuildParam:{mhaName:this.initInfo.dstMhaName,dbApplierDtos:this.getFilteredData(),applierInitGtid:this.gtidCheck.mhaTarget}};console.log(a),this.dataLoading=!0,this.axios.post("/api/drc/v2/config/db/applier",a).then(function(){var a=Object(o["a"])(Object(s["a"])().mark((function a(e){var i,n;return Object(s["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(i=e.data,n=1!==i.status,!n){a.next=9;break}return t.submitted=!0,t.$Message.success("提交成功"),a.next=7,t.getDbAppliers();case 7:a.next=10;break;case 9:t.$Message.warning("提交失败: "+i.message);case 10:case"end":return a.stop()}}),a)})));return function(t){return a.apply(this,arguments)}}()).catch((function(a){t.$Message.error("提交异常: "+a)})).finally((function(){t.gtidCheck.mhaTarget=null,t.dataLoading=!1}))},batchAutoConfigure:function(){var t=this;return Object(o["a"])(Object(s["a"])().mark((function a(){return Object(s["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:t.tableData.map((function(a,e){return t.autoConfigApplier(a,e)}));case 1:case"end":return a.stop()}}),a)})))()},getResources:function(){var t=this;this.axios.get("/api/drc/v2/resource/db/all",{params:{srcMhaName:this.initInfo.srcMhaName,dstMhaName:this.initInfo.dstMhaName,type:1}}).then((function(a){console.log(a.data),t.applierResourceList=a.data.data}))},getDbAppliers:function(){var t=this;return Object(o["a"])(Object(s["a"])().mark((function a(){return Object(s["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:t.dataLoading=!0,t.axios.get("/api/drc/v2/config/mha/dbApplier",{params:{srcMhaName:t.initInfo.srcMhaName,dstMhaName:t.initInfo.dstMhaName}}).then((function(a){1===a.data.status?t.$Message.error("查询 db applier 失败!"):t.tableData=a.data.data})).finally((function(){t.dataLoading=!1}));case 2:case"end":return a.stop()}}),a)})))()},preBatchUpdate:function(){var t=this.$refs.multipleTable.getSelection();void 0!==t&&null!==t&&0!==t.length?(this.batchUpdateModal=!0,this.updateData=t,this.target.ips=[],this.target.gtid=""):this.$Message.warning("请勾选！")},fillMhaApplier:function(){var t=this;this.dataLoading=!0,Promise.all([this.axios.get("/api/drc/v2/config/mha/applier?srcMhaName="+this.initInfo.srcMhaName+"&dstMhaName="+this.initInfo.dstMhaName),this.axios.get("/api/drc/v2/config/mha/dbApplier/gtidTruncated?srcMhaName="+this.initInfo.srcMhaName+"&dstMhaName="+this.initInfo.dstMhaName)]).then(function(){var a=Object(o["a"])(Object(s["a"])().mark((function a(e){var i,n,o,l,c;return Object(s["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(i=Object(r["a"])(e,2),n=i[0],o=i[1],console.log("res1",n),console.log("res2",o),0===n.data.status&&0===o.data.status){a.next=6;break}return t.$Message.error("查询 mha applier 信息失败"),a.abrupt("return");case 6:l=n.data.data,c=o.data.data,t.tableData.forEach((function(t){t.ips=l,t.gtidInit=c}));case 9:case"end":return a.stop()}}),a)})));return function(t){return a.apply(this,arguments)}}()).finally((function(){t.dataLoading=!1}))},preClearAndUpdateMhaGtid:function(){var t=this;function a(t){for(var a=[],e=0,i=Object.entries(t);e<i.length;e++){var n=Object(r["a"])(i[e],2),s=n[0],o=n[1];o&&o.length>0&&a.push({dbName:s,gtidInit:o})}return a}this.dataLoading=!0,Promise.all([this.axios.get("/api/drc/v2/config/mha/dbApplier/gtid?srcMhaName="+this.initInfo.srcMhaName+"&dstMhaName="+this.initInfo.dstMhaName),this.axios.get("/api/drc/v2/config/mha/dbApplier/dbGtid?srcMhaName="+this.initInfo.srcMhaName+"&dstMhaName="+this.initInfo.dstMhaName),this.axios.get("/api/drc/v2/config/mha/dbApplier/dbGtidTruncated?srcMhaName="+this.initInfo.srcMhaName+"&dstMhaName="+this.initInfo.dstMhaName)]).then(function(){var e=Object(o["a"])(Object(s["a"])().mark((function e(i){var n,o,l,c;return Object(s["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(n=Object(r["a"])(i,3),o=n[0],l=n[1],c=n[2],console.log("res1",o),console.log("res2",l),console.log("res3",c),0===o.data.status&&0===l.data.status&&0===c.data.status){e.next=7;break}return t.$Message.error("查询 gtid 信息失败"),e.abrupt("return");case 7:t.gtidCheck.mhaApplied=o.data.data,t.gtidCheck.dbApplied=a(l.data.data),t.gtidCheck.mhaTarget=c.data.data,t.rollbackModal=!0;case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).finally((function(){t.dataLoading=!1}))},clearAndUpdateMhaGtid:function(){var t=this;this.tableData.forEach((function(a){a.ips=t.target.ips,a.gtidInit=t.target.gtid})),this.mhaApplierInitGtid=this.gtidCheck.mhaTarget,this.gtidCheck.mhaTarget&&0!==this.gtidCheck.mhaTarget.length?this.submitDbAppliers():this.$Message.warning("回滚失败，target mha gtid 不存在")},batchUpdateAppliers:function(){var t=this,a=this.$refs.multipleTable.getSelection().map((function(t){return t.dbName}));this.tableData.forEach((function(e){a.includes(e.dbName)&&(e.ips=t.target.ips,t.target.gtid&&(e.gtidInit=t.target.gtid))})),this.$Message.warning("修改成功！共修改"+a.length+"行")},clearDeleteDbReplication:function(t,a){this.deleteData=[],this.batchDeleteModal=!1},deleteDbReplication:function(){var t=this,a=[];this.deleteData.forEach((function(t){return a.push(t.dbReplicationId)})),this.axios.delete("/api/drc/v2/config/dbReplications?dbReplicationIds="+a).then((function(a){1===a.data.status?t.$Message.error("删除失败!"+a.data.message):(t.$Message.success("删除成功!"),t.getDbAppliers(),t.initInfo.multiData=[])}))}},created:function(){var t=this;this.axios.get("/api/drc/v2/permission/meta/mhaReplication/modify").then((function(a){403!==a.data.status?(t.initInfo={srcMhaName:t.$route.query.srcMhaName,srcMhaId:t.$route.query.srcMhaId,dstMhaName:t.$route.query.dstMhaName,applierGroupId:t.$route.query.applierGroupId,srcDc:t.$route.query.srcDc,dstDc:t.$route.query.dstDc,order:t.$route.query.order},console.log("initInfo:"),console.log(t.initInfo),t.getResources(),t.getDbAppliers()):t.$router.push("/nopermission")}))}},p=d,u=e("2877"),h=Object(u["a"])(p,i,n,!1,null,"f55fb68a",null);a["default"]=h.exports}}]);
//# sourceMappingURL=chunk-3f79e392.e7dbe370.js.map