(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-390c5f98"],{"21df":function(e,t,a){"use strict";a("5084")},3780:function(e,t,a){"use strict";a("8dfa")},"471e":function(e,t,a){"use strict";var r=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",[e.hasResp?a("Alert",{staticStyle:{width:"65%","margin-left":"250px"},attrs:{type:e.status,"show-icon":""}},[e._v(" "+e._s(e.title)+" "),a("span",{attrs:{slot:"desc"},domProps:{innerHTML:e._s(e.message)},slot:"desc"})]):e._e(),a("Row",[a("i-col",{attrs:{span:"12"}},[a("Form",{ref:"drc1",staticStyle:{float:"left","margin-top":"50px"},attrs:{model:e.srcBuildParam,rules:e.ruleDrc,"label-width":250}},[a("FormItem",{staticStyle:{width:"600px"},attrs:{label:"源集群名",prop:"srcMhaName"}},[a("Input",{attrs:{placeholder:"请输入源集群名"},on:{input:e.changeSrcMha},model:{value:e.srcBuildParam.mhaName,callback:function(t){e.$set(e.srcBuildParam,"mhaName",t)},expression:"srcBuildParam.mhaName"}})],1),a("FormItem",{attrs:{label:"选择Replicator",prop:"replicator"}},[a("Select",{staticStyle:{width:"250px"},attrs:{multiple:"",placeholder:"选择源集群Replicator"},model:{value:e.srcBuildParam.replicatorIps,callback:function(t){e.$set(e.srcBuildParam,"replicatorIps",t)},expression:"srcBuildParam.replicatorIps"}},e._l(e.replicatorList.src,(function(t){return a("Option",{key:t.ip,attrs:{value:t.ip}},[e._v(e._s(t.ip)+" —— "+e._s(t.az)+" ")])})),1),e._v("   "),a("Button",{attrs:{type:"success"},on:{click:e.autoConfigSrcReplicator}},[e._v("自动录入")])],1),a("FormItem",{staticStyle:{width:"600px"},attrs:{label:"初始拉取位点R"}},[a("Input",{attrs:{placeholder:"变更replicator机器时,请输入binlog拉取位点"},model:{value:e.srcBuildParam.replicatorInitGtid,callback:function(t){e.$set(e.srcBuildParam,"replicatorInitGtid",t)},expression:"srcBuildParam.replicatorInitGtid"}}),a("Row",[a("Col",{attrs:{span:"12"}},[a("Button",{on:{click:e.querySrcMhaMachineGtid}},[e._v("查询mha位点")]),e.hasTest1?a("span",[a("Icon",{attrs:{type:e.testSuccess1?"ios-checkmark-circle":"ios-close-circle",color:e.testSuccess1?"green":"red"}}),e._v(" "+e._s(e.testSuccess1?"查询实时位点成功":"连接查询失败")+" ")],1):e._e()],1),a("Col",{attrs:{span:"12"}},[a("Button",{attrs:{type:"success"},on:{click:e.querySrcMhaGtidCheckRes}},[e._v("位点校验")])],1)],1)],1),a("FormItem",{staticStyle:{width:"600px"},attrs:{label:"同步配置"}},[a("Button",{attrs:{type:"primary",ghost:""},on:{click:e.getSrcDbReplications}},[e._v("同步表管理")])],1),a("FormItem",{staticStyle:{width:"600px"},attrs:{label:"DB Applier 配置"}},[a("Button",{attrs:{type:"primary",ghost:""},on:{click:e.getSrcDbApplierReplications}},[e._v("Db Applier 管理")])],1)],1)],1),a("i-col",{attrs:{span:"12"}},[a("Form",{ref:"drc1",staticStyle:{float:"left","margin-top":"50px"},attrs:{model:e.dstBuildParam,rules:e.ruleDrc,"label-width":250}},[a("FormItem",{staticStyle:{width:"600px"},attrs:{label:"目标集群名",prop:"dstMhaName"}},[a("Input",{attrs:{placeholder:"请输入目标集群名"},on:{input:e.changeDstMha},model:{value:e.dstBuildParam.mhaName,callback:function(t){e.$set(e.dstBuildParam,"mhaName",t)},expression:"dstBuildParam.mhaName"}})],1),a("FormItem",{attrs:{label:"选择Replicator",prop:"replicator"}},[a("Select",{staticStyle:{width:"250px"},attrs:{multiple:"",placeholder:"选择目标集群Replicator"},model:{value:e.dstBuildParam.replicatorIps,callback:function(t){e.$set(e.dstBuildParam,"replicatorIps",t)},expression:"dstBuildParam.replicatorIps"}},e._l(e.replicatorList.dst,(function(t){return a("Option",{key:t.ip,attrs:{value:t.ip}},[e._v(e._s(t.ip)+" —— "+e._s(t.az)+" ")])})),1),e._v("   "),a("Button",{attrs:{type:"success"},on:{click:e.autoConfigDstReplicator}},[e._v("自动录入")])],1),a("FormItem",{staticStyle:{width:"600px"},attrs:{label:"初始拉取位点R"}},[a("Input",{attrs:{placeholder:"变更replicator机器时,请输入binlog拉取位点"},model:{value:e.dstBuildParam.replicatorInitGtid,callback:function(t){e.$set(e.dstBuildParam,"replicatorInitGtid",t)},expression:"dstBuildParam.replicatorInitGtid"}}),a("Row",[a("Col",{attrs:{span:"12"}},[a("Button",{on:{click:e.queryDstMhaMachineGtid}},[e._v("查询mha位点")]),e.hasTest2?a("span",[a("Icon",{attrs:{type:e.testSuccess2?"ios-checkmark-circle":"ios-close-circle",color:e.testSuccess2?"green":"red"}}),e._v(" "+e._s(e.testSuccess2?"查询实时位点成功":"连接查询失败")+" ")],1):e._e()],1),a("Col",{attrs:{span:"12"}},[a("Button",{attrs:{type:"success"},on:{click:e.queryDstMhaGtidCheckRes}},[e._v("位点校验")])],1)],1)],1),a("FormItem",{staticStyle:{width:"600px"},attrs:{label:"同步配置"}},[a("Button",{attrs:{type:"primary",ghost:""},on:{click:e.getDstDbReplications}},[e._v("同步表管理")])],1),a("FormItem",{staticStyle:{width:"600px"},attrs:{label:"DB Applier 配置"}},[a("Button",{attrs:{type:"primary",ghost:""},on:{click:e.getDstDbApplierReplications}},[e._v("Db Applier 管理")])],1)],1)],1)],1),a("Form",{staticStyle:{"margin-top":"50px"},attrs:{"label-width":250}},[a("FormItem",[a("br"),a("Button",{staticStyle:{width:"100px"},attrs:{type:"primary"},on:{click:function(t){e.preCheckConfigure()}}},[e._v("提交")])],1),a("Modal",{attrs:{title:"确认配置信息",width:"900px"},on:{"on-ok":e.submitConfig},model:{value:e.reviewModal,callback:function(t){e.reviewModal=t},expression:"reviewModal"}},[a("Row",{attrs:{gutter:5}},[a("i-col",{attrs:{span:"12"}},[a("Form",{staticStyle:{width:"80%"}},[a("FormItem",{attrs:{label:"源集群名"}},[a("Input",{attrs:{type:"textarea",autosize:{minRows:1,maxRows:30},readonly:""},model:{value:e.srcBuildParam.mhaName,callback:function(t){e.$set(e.srcBuildParam,"mhaName",t)},expression:"srcBuildParam.mhaName"}})],1),a("FormItem",{attrs:{label:"源集群端Replicator"}},[a("Input",{attrs:{type:"textarea",autosize:{minRows:1,maxRows:30},readonly:""},model:{value:e.srcBuildParam.replicatorIps,callback:function(t){e.$set(e.srcBuildParam,"replicatorIps",t)},expression:"srcBuildParam.replicatorIps"}})],1),a("FormItem",{attrs:{label:"源集群端R位点"}},[a("Input",{attrs:{type:"textarea",autosize:{minRows:1,maxRows:30},readonly:""},model:{value:e.srcBuildParam.replicatorInitGtid,callback:function(t){e.$set(e.srcBuildParam,"replicatorInitGtid",t)},expression:"srcBuildParam.replicatorInitGtid"}})],1)],1)],1),a("i-col",{attrs:{span:"12"}},[a("Form",{staticStyle:{width:"80%"}},[a("FormItem",{attrs:{label:"目标集群名"}},[a("Input",{attrs:{type:"textarea",autosize:{minRows:1,maxRows:30},readonly:""},model:{value:e.dstBuildParam.mhaName,callback:function(t){e.$set(e.dstBuildParam,"mhaName",t)},expression:"dstBuildParam.mhaName"}})],1),a("FormItem",{attrs:{label:"目标集群端Replicator"}},[a("Input",{attrs:{type:"textarea",autosize:{minRows:1,maxRows:30},readonly:""},model:{value:e.dstBuildParam.replicatorIps,callback:function(t){e.$set(e.dstBuildParam,"replicatorIps",t)},expression:"dstBuildParam.replicatorIps"}})],1),a("FormItem",{attrs:{label:"目标集群端R位点"}},[a("Input",{attrs:{type:"textarea",autosize:{minRows:1,maxRows:30},readonly:""},model:{value:e.dstBuildParam.replicatorInitGtid,callback:function(t){e.$set(e.dstBuildParam,"replicatorInitGtid",t)},expression:"dstBuildParam.replicatorInitGtid"}})],1)],1)],1)],1)],1),a("Modal",{attrs:{title:"配置结果",width:"1200px"},model:{value:e.resultModal,callback:function(t){e.resultModal=t},expression:"resultModal"}},[a("Form",{staticStyle:{width:"100%"}},[a("FormItem",{attrs:{label:"集群配置"}},[a("Input",{attrs:{type:"textarea",autosize:{minRows:1,maxRows:30},readonly:""},model:{value:e.result,callback:function(t){e.result=t},expression:"result"}})],1)],1)],1),a("Modal",{attrs:{title:"gitd位点校验结果",width:"900px"},model:{value:e.gtidCheck.modal,callback:function(t){e.$set(e.gtidCheck,"modal",t)},expression:"gtidCheck.modal"}},[a("Form",{staticStyle:{width:"80%"}},[a("FormItem",{attrs:{label:"校验结果"}},[a("Input",{attrs:{type:"textarea",autosize:{minRows:1,maxRows:30},readonly:""},model:{value:e.gtidCheck.resVo.legal,callback:function(t){e.$set(e.gtidCheck.resVo,"legal",t)},expression:"gtidCheck.resVo.legal"}})],1),a("FormItem",{attrs:{label:"当前Mha"}},[a("Input",{attrs:{autosize:{minRows:1,maxRows:30},readonly:""},model:{value:e.gtidCheck.resVo.mha,callback:function(t){e.$set(e.gtidCheck.resVo,"mha",t)},expression:"gtidCheck.resVo.mha"}})],1),a("FormItem",{attrs:{label:"配置位点"}},[a("Input",{attrs:{type:"textarea",autosize:{minRows:1,maxRows:30},readonly:""},model:{value:e.gtidCheck.resVo.configGtid,callback:function(t){e.$set(e.gtidCheck.resVo,"configGtid",t)},expression:"gtidCheck.resVo.configGtid"}})],1),a("FormItem",{attrs:{label:"purgedGtid"}},[a("Input",{attrs:{type:"textarea",autosize:{minRows:1,maxRows:30},readonly:""},model:{value:e.gtidCheck.resVo.purgedGtid,callback:function(t){e.$set(e.gtidCheck.resVo,"purgedGtid",t)},expression:"gtidCheck.resVo.purgedGtid"}})],1)],1)],1)],1)],1)},i=[],o=a("b85c"),s=a("53ca"),n=a("2909"),l=(a("fb6a"),a("d3b7"),a("159b"),{name:"drcBuildV2",props:{srcMhaName:String,dstMhaName:String,srcDc:String,dstDc:String,env:String},data:function(){return{result:"",status:"",title:"",message:"",hasResp:!1,hasTest1:!1,testSuccess1:!1,hasTest2:!1,testSuccess2:!1,reviewModal:!1,resultModal:!1,replicatorList:{src:[],dst:[]},srcBuildParam:{mhaName:this.srcMhaName,replicatorIps:[],replicatorInitGtid:""},srcBuildData:{dbApplierDtos:[]},dstBuildParam:{mhaName:this.dstMhaName,replicatorIps:[],replicatorInitGtid:""},dstBuildData:{dbApplierDtos:[]},gtidCheck:{modal:!1,resVo:{mha:"",legal:"",configGtid:"",purgedGtid:""}},ruleDrc:{oldClusterName:[{required:!0,message:"源集群名不能为空",trigger:"blur"}],newClusterName:[{required:!0,message:"新集群名不能为空",trigger:"blur"}],env:[{required:!0,message:"环境不能为空",trigger:"blur"}],replicator:[{required:!0,message:"replicator不能为空",trigger:"blur"}],applier:[{required:!0,message:"applier不能为空",trigger:"blur"}]}}},computed:{dataWithPage:function(){var e=this.nameFilterCheck.tableData,t=this.nameFilterCheck.current*this.nameFilterCheck.size-this.nameFilterCheck.size,a=t+this.nameFilterCheck.size;return Object(n["a"])(e).slice(t,a)}},methods:{flattenObj:function(e){var t={};for(var a in e)if("object"!==Object(s["a"])(e[a])||Array.isArray(e[a]))t[a]=e[a];else{var r=this.flattenObj(e[a]);for(var i in r)t[a+"."+i]=r[i]}return t},autoConfigSrcReplicator:function(){var e=this;this.axios.get("/api/drc/v2/resource/mha/auto?mhaName="+this.srcBuildParam.mhaName+"&type=0&selectedIps="+this.srcBuildParam.replicatorIps).then((function(t){console.log(t.data),e.srcBuildParam.replicatorIps=[],t.data.data.forEach((function(t){return e.srcBuildParam.replicatorIps.push(t.ip)}))}))},autoConfigDstReplicator:function(){var e=this;this.axios.get("/api/drc/v2/resource/mha/auto?mhaName="+this.dstBuildParam.mhaName+"&type=0&selectedIps="+this.dstBuildParam.replicatorIps).then((function(t){console.log(t.data),e.dstBuildParam.replicatorIps=[],t.data.data.forEach((function(t){return e.dstBuildParam.replicatorIps.push(t.ip)}))}))},getSrcMhaResources:function(){var e=this;this.axios.get("/api/drc/v2/resource/mha/all?mhaName="+this.srcBuildParam.mhaName+"&type=0").then((function(t){console.log(t.data),e.replicatorList.src=t.data.data}))},getDstMhaResources:function(){var e=this;this.axios.get("/api/drc/v2/resource/mha/all?mhaName="+this.dstBuildParam.mhaName+"&type=0").then((function(t){console.log(t.data),e.replicatorList.dst=t.data.data}))},getSrcMhaReplicatorsInUse:function(){var e=this;this.axios.get("/api/drc/v2/mha/replicator?mhaName="+this.srcBuildParam.mhaName).then((function(t){e.srcBuildParam.replicatorIps=t.data.data}))},getDstMhaReplicatorsInUse:function(){var e=this;this.axios.get("/api/drc/v2/mha/replicator?mhaName="+this.dstBuildParam.mhaName).then((function(t){console.log(t.data),e.dstBuildParam.replicatorIps=t.data.data}))},getMhaDbAppliersInUse:function(){var e=this;this.axios.get("/api/drc/v2/config/mha/dbApplier?srcMhaName="+this.dstBuildParam.mhaName+"&dstMhaName="+this.srcBuildParam.mhaName).then((function(t){console.log(t.data),e.srcBuildData.dbApplierDtos=t.data.data})),this.axios.get("/api/drc/v2/config/mha/dbApplier?srcMhaName="+this.srcBuildParam.mhaName+"&dstMhaName="+this.dstBuildParam.mhaName).then((function(t){console.log(t.data),e.dstBuildData.dbApplierDtos=t.data.data}))},querySrcMhaMachineGtid:function(){var e=this,t=this;t.axios.get("/api/drc/v2/mha/gtid/executed?mha="+this.srcBuildParam.mhaName).then((function(t){e.hasTest1=!0,0===t.data.status?(e.srcBuildParam.replicatorInitGtid=t.data.data,e.testSuccess1=!0):e.testSuccess1=!1}))},querySrcMhaGtidCheckRes:function(){var e=this;if(null!=this.srcBuildParam.replicatorInitGtid&&""!==this.srcBuildParam.replicatorInitGtid){var t=this;t.axios.get("/api/drc/v2/mha/gtid/checkResult?mha="+this.srcBuildParam.mhaName+"&configGtid="+this.srcBuildParam.replicatorInitGtid).then((function(t){0===t.data.status?(e.gtidCheck.resVo={mha:e.srcBuildParam.mhaName,legal:!0===t.data.data.legal?"合理位点":"binlog已经被purge",configGtid:e.srcBuildParam.replicatorInitGtid,purgedGtid:t.data.data.purgedGtid},e.gtidCheck.modal=!0):alert("位点校验失败!")}))}else alert("位点为空！")},queryDstMhaMachineGtid:function(){var e=this,t=this;t.axios.get("/api/drc/v2/mha/gtid/executed?mha="+this.dstBuildParam.mhaName).then((function(t){e.hasTest2=!0,0===t.data.status?(e.dstBuildParam.replicatorInitGtid=t.data.data,e.testSuccess2=!0):e.testSuccess2=!1}))},queryDstMhaGtidCheckRes:function(){var e=this;if(null!=this.dstBuildParam.replicatorInitGtid&&""!==this.dstBuildParam.replicatorInitGtid){var t=this;t.axios.get("/api/drc/v2/mha/gtid/checkResult?mha="+this.dstBuildParam.mhaName+"&configGtid="+this.dstBuildParam.replicatorInitGtid).then((function(t){0===t.data.status?(e.gtidCheck.resVo={mha:e.dstBuildParam.mhaName,legal:!0===t.data.data.legal?"合理位点":"binlog已经被purge",configGtid:e.dstBuildParam.replicatorInitGtid,purgedGtid:t.data.data.purgedGtid},e.gtidCheck.modal=!0):alert("位点校验失败!")}))}else alert("位点为空！")},getSrcDc:function(){var e=this;this.axios.get("/api/drc/v2/mha/dc?mhaName="+this.srcBuildParam.mhaName).then((function(t){e.srcDc=t.data.data}))},getDstDc:function(){var e=this;this.axios.get("/api/drc/v2/mha/dc?mhaName="+this.dstBuildParam.mhaName).then((function(t){e.dstDc=t.data.data}))},changeSrcMha:function(){this.$emit("srcMhaNameChanged",this.srcBuildParam.mhaName),this.getSrcMhaResources(),this.getSrcMhaReplicatorsInUse(),this.getMhaDbAppliersInUse(),this.getSrcDc()},changeDstMha:function(){this.$emit("dstMhaNameChanged",this.dstBuildParam.mhaName),this.getDstMhaResources(),this.getDstMhaReplicatorsInUse(),this.getMhaDbAppliersInUse(),this.getDstDc()},start:function(){this.$Loading.start()},finish:function(){this.$Loading.finish()},error:function(){this.$Loading.error()},changeModal:function(e){var t=this;this.$refs[e].validate((function(e){e?t.drc.reviewModal=!0:t.$Message.error("仍有必填项未填!")}))},preCheckConfigure:function(){this.reviewModal=!0},reviewConfigure:function(){this.drc.reviewModal=!0},submitConfig:function(){var e=this,t=this;this.axios.post("/api/drc/v2/config/",{srcBuildParam:this.srcBuildParam,dstBuildParam:this.dstBuildParam}).then((function(a){console.log(a.data),t.result=a.data,t.reviewModal=!1,t.resultModal=!0,e.refresh()}))},getSrcDbReplications:function(){this.$router.push({path:"/dbTables",query:{srcMhaName:this.dstBuildParam.mhaName,dstMhaName:this.srcBuildParam.mhaName,srcDc:this.dstDc,dstDc:this.srcDc,order:!0}})},getDstDbReplications:function(){this.$router.push({path:"/dbTables",query:{srcMhaName:this.srcBuildParam.mhaName,dstMhaName:this.dstBuildParam.mhaName,srcDc:this.srcDc,dstDc:this.dstDc,order:!0}})},getSrcDbApplierReplications:function(){this.$router.push({path:"/dbAppliers",query:{srcMhaName:this.dstBuildParam.mhaName,dstMhaName:this.srcBuildParam.mhaName,srcDc:this.dstDc,dstDc:this.srcDc,order:!0}})},getDstDbApplierReplications:function(){this.$router.push({path:"/dbAppliers",query:{srcMhaName:this.srcBuildParam.mhaName,dstMhaName:this.dstBuildParam.mhaName,srcDc:this.srcDc,dstDc:this.dstDc,order:!0}})},handleChangeSize:function(e){this.size=e},hasAppliers:function(e){var t,a=Object(o["a"])(e);try{for(a.s();!(t=a.n()).done;){var r=t.value;if(r.ips&&r.ips.length>0)return!0}}catch(i){a.e(i)}finally{a.f()}return!1},refresh:function(){this.getSrcMhaReplicatorsInUse(),this.getDstMhaReplicatorsInUse(),this.getMhaDbAppliersInUse(),this.getSrcDc(),this.getDstDc()}},created:function(){this.getSrcMhaResources(),this.getDstMhaResources(),this.refresh()}}),c=l,m=(a("3780"),a("2877")),d=Object(m["a"])(c,r,i,!1,null,"38991636",null);t["a"]=d.exports},5084:function(e,t,a){},"666c":function(e,t,a){"use strict";a.r(t);var r=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("base-component",[a("Breadcrumb",{style:{margin:"15px 0 15px 185px",position:"fixed"}},[a("BreadcrumbItem",{attrs:{to:"/home"}},[e._v("首页")]),a("BreadcrumbItem",{attrs:{to:"/v2/mhaDbReplications"}},[e._v("DB 复制链路")]),a("BreadcrumbItem",[e._v("DRC-DB 配置")])],1),a("Content",{staticClass:"content",style:{padding:"10px",background:"#ffffff",margin:"50px 0 111px 185px",zIndex:"1"}},[a("Row",{attrs:{gutter:10,align:"middle"}},[a("Col",{attrs:{span:"18"}},[a("Form",{staticStyle:{"margin-right":"20px","margin-top":"10px"},attrs:{model:e.formItem,"label-width":100}},[a("FormItem",{attrs:{label:"数据库",required:!0}},[a("Select",{attrs:{filterable:"",disabled:!!e.meta.fixDb,placeholder:"请搜索数据库信息","remote-method":e.getExistDb,loading:e.dataLoading},on:{"on-change":e.selectDb},model:{value:e.meta.dbName,callback:function(t){e.$set(e.meta,"dbName",t)},expression:"meta.dbName"}},e._l(e.meta.dbOptions,(function(t,r){return a("Option",{key:r,attrs:{value:t.dbName}},[e._v(e._s(t.dbName))])})),1)],1),a("FormItem",{attrs:{label:"同步方向",required:!0}},[a("RadioGroup",{attrs:{"button-style":"solid"},on:{"on-change":e.afterSelectExistReplication},model:{value:e.selectedExistReplication,callback:function(t){e.selectedExistReplication=t},expression:"selectedExistReplication"}},e._l(e.meta.existReplicationRegionOptions,(function(t){return a("Radio",{key:t.srcRegionName+" -> "+t.dstRegionName,attrs:{label:t.srcRegionName+" -> "+t.dstRegionName,border:""}},[e._v(" "+e._s(t.srcRegionName+" -> "+t.dstRegionName)+" ")])})),1),a("Button",{attrs:{type:"primary",icon:"md-add",ghost:""},on:{click:e.goToCreateReplication}},[e._v("新增")]),a("Modal",{attrs:{width:"1200px","footer-hide":!0,title:"创建同步"},model:{value:e.createModal.open,callback:function(t){e.$set(e.createModal,"open",t)},expression:"createModal.open"}},[e.createModal.open?a("mha-preview",{attrs:{"db-name":e.meta.dbName,"replication-type":0,"exist-replication-region-options":e.meta.existReplicationRegionOptions},on:{updated:e.selectDb}}):e._e()],1)],1),a("Divider",{attrs:{orientation:"left"}},[e._v("同步表")]),a("Card",{staticStyle:{width:"100%"}},[a("tables",{attrs:{"table-data":e.drcConfig.logicTableSummaryDtos,"data-loading":e.configDataLoading,"src-region":e.meta.srcRegionName,"dst-region":e.meta.dstRegionName,"db-name":e.meta.dbName,"db-names":e.drcConfig.dbNames},on:{updated:e.getDrcConfig}})],1),a("Divider",{attrs:{orientation:"left"}},[e._v("同步DB")]),a("Card",{staticStyle:{width:"100%"}},[e.drcConfig.mhaReplications?a("mha-replication-panel",{attrs:{"mha-replications":e.drcConfig.mhaReplications},on:{updated:e.getDrcConfig}}):e._e()],1)],1)],1)],1)],1)],1)},i=[],o=a("53ca"),s=a("c7eb"),n=a("1da1"),l=(a("d3b7"),a("ac1f"),a("5319"),a("498a"),function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{style:{padding:"1px 1px",height:"100%"}},[a("Table",{ref:"multipleTable",staticStyle:{"margin-top":"20px"},attrs:{stripe:"",columns:e.columns,data:e.tableData,loading:e.dataLoading,border:""},scopedSlots:e._u([{key:"action",fn:function(t){var r=t.row,i=t.index;return[a("Button",{staticStyle:{"margin-right":"5px"},attrs:{type:"primary",size:"small"},on:{click:function(t){return e.goToUpdateConfig(r,i)}}},[e._v("修改 ")]),a("Button",{staticStyle:{"margin-right":"5px"},attrs:{type:"error",size:"small"},on:{click:function(t){return e.goToDeleteConfig(r,i)}}},[e._v("删除 ")])]}}])}),a("br"),a("Button",{attrs:{type:"success",icon:"md-add"},on:{click:e.goToInsertConfig}},[e._v(" 新增 ")]),a("Modal",{attrs:{width:"1200px","footer-hide":!0,title:e.actionTitle},model:{value:e.editModal.open,callback:function(t){e.$set(e.editModal,"open",t)},expression:"editModal.open"}},[e.editModal.open?a("db-replication-config",{ref:"dbReplicationConfigComponent",attrs:{"config-data":e.selectedRow,"src-region":e.srcRegion,"dst-region":e.dstRegion,"db-names":e.dbNames,"form-action":e.action},on:{finished:e.finishConfig}}):e._e()],1)],1)}),c=[],m=(a("4ec9"),a("3ca3"),a("ddb0"),function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{style:{padding:"1px 1px",height:"100%"}},[a("Row",{attrs:{gutter:10,align:"middle"}},[a("Col",{attrs:{span:"13"}},[a("Form",{staticStyle:{"margin-right":"20px","margin-top":"10px"},attrs:{model:e.formItem,disabled:"delete"===e.formAction,"label-width":100}},[e.alertInfo.show?a("Alert",{attrs:{type:"warning","show-icon":"",closable:""},scopedSlots:e._u([{key:"desc",fn:function(){return[e._v(e._s(e.alertInfo.message))]},proxy:!0}],null,!1,3041357252)},[e._v(" "+e._s(e.alertInfo.title)+" ")]):e._e(),e.alertInfo.successShow?a("Alert",{attrs:{type:"success","show-icon":"",closable:""},scopedSlots:e._u([{key:"desc",fn:function(){return[e._v(e._s(e.alertInfo.message))]},proxy:!0}],null,!1,3041357252)},[e._v(" "+e._s(e.alertInfo.title)+" ")]):e._e(),a("FormItem",{attrs:{prop:"dbName",label:"库名",required:!0}},[a("Input",{attrs:{type:"textarea",autosize:!0,readonly:!0,border:!1,placeholder:"请输入库名（支持正则）"},model:{value:e.formItem.dbName,callback:function(t){e.$set(e.formItem,"dbName",t)},expression:"formItem.dbName"}})],1),a("FormItem",{attrs:{label:"同步表",required:!0}},[a("Input",{attrs:{placeholder:"请输入正则表达式"},on:{"on-keydown":function(t){if(!t.type.indexOf("key")&&e._k(t.keyCode,"space",32,t.key,[" ","Spacebar"]))return null;t.preventDefault()},"on-blur":e.afterEnterTableName},model:{value:e.formItem.tableName,callback:function(t){e.$set(e.formItem,"tableName",t)},expression:"formItem.tableName"}})],1),a("FormItem",{attrs:{label:"行过滤"}},[a("i-switch",{attrs:{size:"large"},scopedSlots:e._u([{key:"open",fn:function(){return[a("span",[e._v("On")])]},proxy:!0},{key:"close",fn:function(){return[a("span",[e._v("Off")])]},proxy:!0}]),model:{value:e.formItem.switch.rowsFilter,callback:function(t){e.$set(e.formItem.switch,"rowsFilter",t)},expression:"formItem.switch.rowsFilter"}})],1),e.formItem.switch.rowsFilter?a("Card",{staticStyle:{"margin-left":"100px"},scopedSlots:e._u([{key:"title",fn:function(){return[a("Icon",{attrs:{type:"md-settings"}}),e._v(" 行过滤配置 "),a("Button",{staticStyle:{"margin-left":"50px"},attrs:{icon:"ios-refresh",size:"small",type:"primary",loading:e.commonColumnLoading},on:{click:e.getCommonColumns}},[e._v("获取公共字段 ")])]},proxy:!0}],null,!1,571298879)},[a("FormItem",{attrs:{label:"模式"}},[a("Select",{staticStyle:{width:"200px"},attrs:{placeholder:"选择行过滤模式"},model:{value:e.formItem.rowsFilterCreateParam.mode,callback:function(t){e.$set(e.formItem.rowsFilterCreateParam,"mode",t)},expression:"formItem.rowsFilterCreateParam.mode"}},e._l(e.formItem.constants.rowsFilter.modes,(function(t){return a("Option",{key:t.mode,attrs:{value:t.mode}},[e._v(" "+e._s(t.name)+" ")])})),1)],1),e.useTripUdlOrUidMode?a("div",[e.fillContextByRegion?a("FormItem",{attrs:{label:"规则内容"}},[a("Select",{staticStyle:{width:"200px"},attrs:{multiple:"",placeholder:"Region 选择"},model:{value:e.formItem.rowsFilter.configInTripUid.regionsChosen,callback:function(t){e.$set(e.formItem.rowsFilter.configInTripUid,"regionsChosen",t)},expression:"formItem.rowsFilter.configInTripUid.regionsChosen"}},e._l(e.formItem.constants.rowsFilter.regionsForChose,(function(t){return a("Option",{key:t,attrs:{value:t}},[e._v(" "+e._s(t)+" ")])})),1)],1):e._e(),e.showUdlConfigDetail?a("div",[a("Divider",[e._v("UDL配置")]),a("FormItem",{attrs:{label:"UDL字段"}},[a("Select",{staticStyle:{width:"200px"},attrs:{filterable:"","allow-create":"",multiple:"",disabled:e.commonColumnLoading,placeholder:"不选默认则无UDL配置"},model:{value:e.formItem.rowsFilterCreateParam.udlColumns,callback:function(t){e.$set(e.formItem.rowsFilterCreateParam,"udlColumns",t)},expression:"formItem.rowsFilterCreateParam.udlColumns"}},e._l(e.formItem.constants.columnsForChose,(function(t){return a("Option",{key:t,attrs:{value:t}},[e._v(e._s(t)+" ")])})),1)],1),e.hasUdlColumn?a("FormItem",{attrs:{label:"DRC UDL策略id"}},[a("Select",{staticStyle:{width:"200px"},attrs:{filterable:"","allow-create":"",placeholder:"请选择ucs策略id"},model:{value:e.formItem.rowsFilterCreateParam.drcStrategyId,callback:function(t){e.$set(e.formItem.rowsFilterCreateParam,"drcStrategyId",t)},expression:"formItem.rowsFilterCreateParam.drcStrategyId"}},e._l(e.formItem.constants.rowsFilter.drcStrategyIdsForChose,(function(t){return a("Option",{key:t,attrs:{value:t}},[e._v(e._s(t)+" ")])})),1)],1):e._e()],1):e._e(),e.showUidConfigDetail?a("div",[a("Divider",[e._v("UID配置")]),a("FormItem",{attrs:{label:"UID字段"}},[a("Select",{staticStyle:{width:"200px"},attrs:{filterable:"","allow-create":"",multiple:"",disabled:e.commonColumnLoading,placeholder:"不选默认则无UID配置"},model:{value:e.formItem.rowsFilterCreateParam.columns,callback:function(t){e.$set(e.formItem.rowsFilterCreateParam,"columns",t)},expression:"formItem.rowsFilterCreateParam.columns"}},e._l(e.formItem.constants.columnsForChose,(function(t){return a("Option",{key:t,attrs:{value:t}},[e._v(e._s(t)+" ")])})),1)],1),e.hasUidColumn?a("FormItem",{attrs:{label:"fetchMode"}},[a("Select",{staticStyle:{width:"200px"},attrs:{placeholder:"选择"},on:{"on-change":function(t){return e.fetchModeChange()}},model:{value:e.formItem.rowsFilterCreateParam.fetchMode,callback:function(t){e.$set(e.formItem.rowsFilterCreateParam,"fetchMode",t)},expression:"formItem.rowsFilterCreateParam.fetchMode"}},e._l(e.formItem.constants.rowsFilter.fetchModeForChose,(function(t){return a("Option",{key:t.k,attrs:{value:t.v}},[e._v(" "+e._s(t.k)+" ")])})),1)],1):e._e(),e.hasUidColumn?a("FormItem",{attrs:{label:"空处理"}},[a("Checkbox",{model:{value:e.formItem.rowsFilterCreateParam.illegalArgument,callback:function(t){e.$set(e.formItem.rowsFilterCreateParam,"illegalArgument",t)},expression:"formItem.rowsFilterCreateParam.illegalArgument"}},[e._v("【字段为空时】同步")])],1):e._e()],1):e._e()],1):e.useCustomSoaMode?a("div",[a("FormItem",{attrs:{label:"相关字段"}},[a("Select",{staticStyle:{width:"200px"},attrs:{filterable:"","allow-create":"",multiple:"",placeholder:"选择相关字段"},on:{"on-create":e.handleCreateColumn},model:{value:e.formItem.rowsFilterCreateParam.columns,callback:function(t){e.$set(e.formItem.rowsFilterCreateParam,"columns",t)},expression:"formItem.rowsFilterCreateParam.columns"}},e._l(e.formItem.constants.columnsForChose,(function(e){return a("Option",{key:e,attrs:{value:e,lable:e}})})),1)],1),a("FormItem",{attrs:{label:"ServiceCode"}},[a("Select",{staticStyle:{width:"200px"},attrs:{filterable:"","allow-create":"",placeholder:"请选择soaServiceCode"},on:{"on-create":e.handleCreateSoaServiceCode},model:{value:e.formItem.rowsFilterCreateParam.drcStrategyId,callback:function(t){e.$set(e.formItem.rowsFilterCreateParam,"drcStrategyId",t)},expression:"formItem.rowsFilterCreateParam.drcStrategyId"}},e._l(e.formItem.constants.serviceCodeForChose,(function(t){return a("Option",{key:t,attrs:{value:t}},[e._v(e._s(t)+" ")])})),1)],1),a("FormItem",{attrs:{label:"服务名"}},[a("Select",{staticStyle:{width:"200px"},attrs:{filterable:"","allow-create":"",placeholder:"请选择服务名"},on:{"on-create":e.handleCreateSoaServiceName},model:{value:e.formItem.rowsFilterCreateParam.context,callback:function(t){e.$set(e.formItem.rowsFilterCreateParam,"context",t)},expression:"formItem.rowsFilterCreateParam.context"}},e._l(e.formItem.constants.serviceNameForChose,(function(t){return a("Option",{key:t,attrs:{value:t}},[e._v(e._s(t)+" ")])})),1)],1)],1):a("div",[a("FormItem",{attrs:{label:"规则内容"}},[a("Input",{staticStyle:{width:"250px"},attrs:{type:"textarea",placeholder:"请输入行过滤内容"},model:{value:e.formItem.rowsFilterCreateParam.context,callback:function(t){e.$set(e.formItem.rowsFilterCreateParam,"context",t)},expression:"formItem.rowsFilterCreateParam.context"}})],1),a("FormItem",{attrs:{label:"相关字段"}},[a("Select",{staticStyle:{width:"200px"},attrs:{filterable:"","allow-create":"",multiple:"",placeholder:"选择相关字段"},model:{value:e.formItem.rowsFilterCreateParam.columns,callback:function(t){e.$set(e.formItem.rowsFilterCreateParam,"columns",t)},expression:"formItem.rowsFilterCreateParam.columns"}},e._l(e.formItem.constants.columnsForChose,(function(e){return a("Option",{key:e,attrs:{value:e,lable:e}})})),1)],1)],1)],1):e._e(),a("FormItem",{attrs:{label:"列过滤"}},[a("i-switch",{attrs:{size:"large"},scopedSlots:e._u([{key:"open",fn:function(){return[a("span",[e._v("On")])]},proxy:!0},{key:"close",fn:function(){return[a("span",[e._v("Off")])]},proxy:!0}]),model:{value:e.formItem.switch.colsFilter,callback:function(t){e.$set(e.formItem.switch,"colsFilter",t)},expression:"formItem.switch.colsFilter"}})],1),e.formItem.switch.colsFilter?a("Card",{staticStyle:{"margin-left":"100px"},scopedSlots:e._u([{key:"title",fn:function(){return[a("Icon",{attrs:{type:"md-settings"}}),e._v(" 列过滤配置 "),a("Button",{staticStyle:{"margin-left":"50px"},attrs:{icon:"ios-refresh",size:"small",type:"primary",loading:e.commonColumnLoading},on:{click:e.getCommonColumns}},[e._v("获取公共字段 ")])]},proxy:!0}],null,!1,2228726756)},[a("FormItem",{attrs:{label:"模式"}},[a("Select",{staticStyle:{width:"200px"},attrs:{placeholder:"选择字段过滤模式"},model:{value:e.formItem.columnsFilterCreateParam.mode,callback:function(t){e.$set(e.formItem.columnsFilterCreateParam,"mode",t)},expression:"formItem.columnsFilterCreateParam.mode"}},e._l(e.formItem.constants.colsFilter.modes,(function(t){return a("Option",{key:t.mode,attrs:{value:t.mode}},[e._v(" "+e._s(t.name)+" ")])})),1)],1),a("FormItem",{attrs:{label:"字段"}},[a("Select",{staticStyle:{width:"200px"},attrs:{filterable:"","allow-create":"",multiple:"",placeholder:"选择相关的字段",disabled:e.commonColumnLoading},on:{"on-create":e.handleCreateColumn},model:{value:e.formItem.columnsFilterCreateParam.columns,callback:function(t){e.$set(e.formItem.columnsFilterCreateParam,"columns",t)},expression:"formItem.columnsFilterCreateParam.columns"}},e._l(e.formItem.constants.columnsForChose,(function(t){return a("Option",{key:t,attrs:{value:t}},[e._v(e._s(t)+" ")])})),1)],1)],1):e._e(),a("br"),a("Row",[a("Col",{attrs:{span:"6",offset:"8"}}),a("Col",{attrs:{span:"6",offset:"4"}})],1)],1)],1),a("Col",{attrs:{span:"11"}},[a("db-tables-preview",{attrs:{"src-region-name":e.srcRegion,"dst-region-name":e.dstRegion,"db-name":e.formItem.dbName,"table-names":e.formItem.tableName,mode:e.formItem.buildMode,"replication-type":Number(0)}})],1)],1),a("Divider"),a("Button",{staticStyle:{"margin-left":"50px"},attrs:{type:e.buttonTypeMap.get(e.formAction),loading:e.dataLoading||e.commonColumnLoading},on:{click:e.submitAll}},[e._v(e._s(e.buttonTextMap.get(e.formAction))+" ")])],1)}),d=[],u=a("2909"),p=(a("caad"),a("a15b"),a("fb6a"),a("b0c0"),a("2532"),a("efa3")),h={components:{DbTablesPreview:p["a"]},FORM_ACTION_OPTION:{CREATE:"create",EDIT:"edit",DELETE:"delete"},name:"dbReplicationConfig",props:{configData:{},srcRegion:String,dstRegion:String,dbNames:Array,formAction:String},emits:["finished"],data:function(){return{meta:{rowsFilterId:null,colsFilterId:null,dbReplicationIds:[],originLogicTableConfig:{}},formItem:{buildMode:2,dbName:null,tableName:null,rowsFilterCreateParam:this.rowsFilterCreateParamInit(),columnsFilterCreateParam:this.columnsFilterCreateParamInit(),rowsFilter:{configInTripUid:{regionsChosen:[]}},switch:{rowsFilter:!1,colsFilter:!1},constants:{rowsFilter:{filterMode:{JAVA_REGEX:0,TRIP_UDL:1,AVIATOR_REGEX:3,TRIP_UDL_UID:5,CUSTOM_SOA:6},fetchMode:{RPC:0,BlackList:1,WhiteList:2,BlackList_Global:3},modes:[{name:"trip_udl",mode:1},{name:"java_regex",mode:0},{name:"aviator_regex",mode:3},{name:"trip_udl_uid",mode:5},{name:"custom_soa",mode:6}],regionsForChose:["SGP","SIN","SH","FRA"],drcStrategyIdsForChose:[2000000002],fetchModeForChose:[{k:"RPC调用",v:0},{k:"BlackList",v:1},{k:"WhiteList",v:2},{k:"BlackListGlobal",v:3}]},colsFilter:{modes:[{name:"exclude",mode:0},{name:"include",mode:1},{name:"regex",mode:2}]},columnsForChose:[],serviceCodeForChose:[32578],serviceNameForChose:["DataSyncService","FilterRowService"]}},checkTableDataList:[],table:{dbMhaTableLoading:!1,dbMhaTableColumn:[{title:"DB名",key:"dbName"},{title:"源集群",key:"srcMhaName",render:function(e,t){var a=t.row,r=a.srcMha;if(null!=r)return e("div",[e("span",r.name),e("span",{style:{float:"right",color:"#ababab"}},r.regionName+"("+r.dcName+")")])}},{title:"目标集群",key:"dstMhaName",render:function(e,t){var a=t.row,r=a.dstMha;if(null!=r)return e("div",[e("span",r.name),e("span",{style:{float:"right",color:"#ababab"}},r.regionName+"("+r.dcName+")")])}}],dbMhaTablePage:{total:0,current:1,size:5,pageSizeOpts:[5,10,20,100]},dbTableLoading:!1,dbTableColumn:[{title:"序号",width:75,align:"center",fixed:"left",render:function(e,t){return e("span",t.index+1)}},{title:"库名",key:"schema",resizable:!0},{title:"表名",key:"table",resizable:!0},{title:"结果",align:"center",render:function(e,t){var a=t.row,r="ok"!==a.res?"volcano":"green",i=a.res;return e("Tag",{props:{color:r}},i)}}],dbTablePage:{total:0,current:1,size:5,pageSizeOpts:[5,10,20,100]}},alertInfo:{show:!1,successShow:!1,title:null,message:null},buttonTextMap:new Map([["create","新增表同步"],["edit","更新表同步"],["delete","删除表同步"]]),buttonTypeMap:new Map([["create","success"],["edit","primary"],["delete","error"]]),dataLoading:!1,successSubmit:!1,commonColumnLoading:!1}},methods:{getParams:function(){var e={};return e.buName=this.formItem.buName,e.tag=this.formItem.tag,e.mode=this.formItem.buildMode,e.srcRegionName=this.srcRegion,e.dstRegionName=this.dstRegion,this.gtidConfigurable&&(e.gtidInit=this.formItem.gtidInit),e.tblsFilterDetail={tableNames:this.formItem.tableName},e.dbName=this.formItem.dbName,e},getEditParams:function(){var e={};return e.dbReplicationIds=this.meta.dbReplicationIds,e.dbNames=this.dbNames,e.srcRegionName=this.srcRegion,e.dstRegionName=this.dstRegion,e.logicTableConfig={logicTable:this.formItem.tableName,rowsFilterId:this.formItem.switch.rowsFilter?this.meta.rowsFilterId:null,colsFilterId:this.formItem.switch.colsFilter?this.meta.colsFilterId:null},e.originLogicTableConfig=this.meta.originLogicTableConfig,this.formItem.switch.rowsFilter&&(this.useTripUdlOrUidMode&&(this.fillContextByRegion?this.formItem.rowsFilterCreateParam.context=this.formItem.rowsFilter.configInTripUid.regionsChosen.join(","):this.formItem.rowsFilterCreateParam.context="//filter by config"),e.openRowsFilterConfig=!0,e.rowsFilterCreateParam=this.formItem.rowsFilterCreateParam),this.formItem.switch.colsFilter&&(e.openColsFilterConfig=!0,e.columnsFilterCreateParam=this.formItem.columnsFilterCreateParam),console.log(e),e},getRowsFilterConfig:function(){var e=this;return Object(n["a"])(Object(s["a"])().mark((function t(){return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.axios.get("/api/drc/v2/autoconfig/getRowsFilterView?rowsFilterId="+e.meta.rowsFilterId).then((function(t){if(1===t.data.status)e.$Message.error("查询行过滤配置失败!");else{var a=t.data.data;null==a||(e.formItem.switch.rowsFilter=!0,e.formItem.rowsFilterCreateParam.context=a.context,e.formItem.rowsFilterCreateParam.mode=a.mode,e.useTripUdlOrUidMode?e.formItem.rowsFilter.configInTripUid.regionsChosen=a.context.split(","):e.formItem.rowsFilter.configInTripUid={regionsChosen:[]},e.formItem.rowsFilterCreateParam.columns=null===a.columns?[]:a.columns,null!==a.udlColumns&&(e.formItem.rowsFilterCreateParam.udlColumns=a.udlColumns),e.formItem.rowsFilterCreateParam.drcStrategyId=0===a.drcStrategyId?null:a.drcStrategyId,e.formItem.rowsFilterCreateParam.routeStrategyId=a.routeStrategyId,e.formItem.rowsFilterCreateParam.illegalArgument=a.illegalArgument,e.formItem.rowsFilterCreateParam.fetchMode=a.fetchMode)}}));case 2:case"end":return t.stop()}}),t)})))()},getColsFilterConfig:function(){var e=this;return Object(n["a"])(Object(s["a"])().mark((function t(){return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.axios.get("/api/drc/v2/autoconfig/getColsFilterView?colsFilterId="+e.meta.colsFilterId).then((function(t){if(1===t.data.status)e.$Message.error("查询字段过滤配置失败!");else{var a=t.data.data;null==a||(e.formItem.switch.colsFilter=!0,e.formItem.columnsFilterCreateParam.mode=a.mode,e.formItem.columnsFilterCreateParam.columns=a.columns)}}));case 2:case"end":return t.stop()}}),t)})))()},getCommonColumns:function(){var e=this;return Object(n["a"])(Object(s["a"])().mark((function t(){var a;return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return a=e.getParams(),e.formItem.constants.columnsForChose=[],e.commonColumnLoading=!0,t.next=5,e.axios.get("/api/drc/v2/autoconfig/commonColumns",{params:e.flattenObj(a)}).then((function(t){1===t.data.status?e.$Message.error("查询公共列名失败，请手动添加："+t.data.message):(e.formItem.constants.columnsForChose=t.data.data,e.$Message.info("查询公共列名数："+t.data.data.length))})).catch((function(t){e.$Message.error("查询公共列名异常: "+t)})).finally((function(){e.commonColumnLoading=!1}));case 5:case"end":return t.stop()}}),t)})))()},handleCreateColumn:function(e){this.contains(this.formItem.constants.columnsForChose,e)?alert("已有项禁止创建"):""!==e&&void 0!==e&&null!==e?this.formItem.constants.columnsForChose.push(e):alert("字段不能为空")},handleCreateSoaServiceCode:function(e){this.contains(this.formItem.constants.serviceCodeForChose,e)?alert("已有项禁止创建"):""!==e&&void 0!==e&&null!==e&&0!==e?this.formItem.constants.serviceCodeForChose.push(e):alert("serviceCode不能为空")},handleCreateSoaServiceName:function(e){this.contains(this.formItem.constants.serviceNameForChose,e)?alert("已有项禁止创建"):""!==e&&void 0!==e&&null!==e?this.formItem.constants.serviceNameForChose.push(e):alert("serviceName不能为空")},afterEnterTableName:function(){var e=this;return Object(n["a"])(Object(s["a"])().mark((function t(){return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.getTableInfo();case 2:case"end":return t.stop()}}),t)})))()},flattenObj:function(e){var t={};for(var a in e)if("object"!==Object(o["a"])(e[a])||Array.isArray(e[a]))t[a]=e[a];else{var r=this.flattenObj(e[a]);for(var i in r)t[a+"."+i]=r[i]}return t},refresh:function(){var e=this;return Object(n["a"])(Object(s["a"])().mark((function t(){return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.formItem.dbName=e.dbNames.join(","),!e.configData){t.next=25;break}if(console.log("edit panel"),e.formItem.tableName=e.configData.config.logicTable,e.meta.rowsFilterId=e.configData.config.rowsFilterId,e.meta.colsFilterId=e.configData.config.colsFilterId,e.getCommonColumns(),!e.meta.rowsFilterId){t.next=12;break}return t.next=10,e.getRowsFilterConfig(e.meta.rowsFilterId);case 10:t.next=14;break;case 12:e.formItem.switch.rowsFilter=!1,e.formItem.rowsFilterCreateParam=e.rowsFilterCreateParamInit();case 14:if(!e.meta.colsFilterId){t.next=19;break}return t.next=17,e.getColsFilterConfig(e.meta.colsFilterId);case 17:t.next=21;break;case 19:e.formItem.switch.colsFilter=!1,e.formItem.columnsFilterCreateParam=e.columnsFilterCreateParamInit();case 21:e.meta.dbReplicationIds=e.configData.dbReplicationIds,e.meta.originLogicTableConfig=e.configData.config,t.next=26;break;case 25:console.log("insert new config");case 26:case"end":return t.stop()}}),t)})))()},submitAll:function(){var e=this;return Object(n["a"])(Object(s["a"])().mark((function t(){var a,r;return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return a=e,a.dataLoading=!0,a.alertInfo.show=!1,a.alertInfo.successShow=!1,a.successSubmit=!1,r=e.getEditParams(),t.next=8,a.axios.post("/api/drc/v2/autoconfig/dbReplication/"+e.formAction,r).then((function(e){var t=e.data,r=0===t.status;r?(a.$Message.success("提交成功"),a.successSubmit=!0,a.alertInfo.successShow=!0,a.alertInfo.message=null,a.alertInfo.title="提交成功",a.$emit("finished")):(a.$Message.warning("提交失败: "+t.message),a.alertInfo.show=!0,a.alertInfo.title="提交失败",a.alertInfo.message=t.message)})).catch((function(e){a.$Message.error("提交异常: "+e)})).finally((function(){a.dataLoading=!1}));case 8:case"end":return t.stop()}}),t)})))()},rowsFilterCreateParamInit:function(){return{mode:1,drcStrategyId:2000000002,routeStrategyId:0,udlColumns:[],columns:[],context:"",illegalArgument:!1,fetchMode:0}},columnsFilterCreateParamInit:function(){return{mode:null,columns:[]}}},computed:{preCheckTablePage:function(){var e=this.checkTableDataList,t=this.table.dbTablePage.current*this.table.dbTablePage.size-this.table.dbTablePage.size,a=t+this.table.dbTablePage.size;return Object(u["a"])(e).slice(t,a)},useTripUdlOrUidMode:function(){return[this.formItem.constants.rowsFilter.filterMode.TRIP_UDL,this.formItem.constants.rowsFilter.filterMode.TRIP_UDL_UID].includes(this.formItem.rowsFilterCreateParam.mode)},useCustomSoaMode:function(){return[this.formItem.constants.rowsFilter.filterMode.CUSTOM_SOA].includes(this.formItem.rowsFilterCreateParam.mode)},hasUdlColumn:function(){return 0!==this.formItem.rowsFilterCreateParam.udlColumns.length},fillContextByRegion:function(){return this.formItem.rowsFilterCreateParam.fetchMode===this.formItem.constants.rowsFilter.fetchMode.RPC},hasUidColumn:function(){return 0!==this.formItem.rowsFilterCreateParam.columns.length},showUdlConfigDetail:function(){return this.formItem.rowsFilterCreateParam.mode===this.formItem.constants.rowsFilter.filterMode.TRIP_UDL_UID||this.hasUdlLegalConfig||!this.hasUidLegalConfig},showUidConfigDetail:function(){return this.formItem.rowsFilterCreateParam.mode===this.formItem.constants.rowsFilter.filterMode.TRIP_UDL_UID||this.hasUidLegalConfig||!this.hasUdlLegalConfig},hasUdlLegalConfig:function(){return 0!==this.formItem.rowsFilterCreateParam.udlColumns.length&&null!=this.formItem.rowsFilterCreateParam.drcStrategyId&&this.formItem.rowsFilterCreateParam.drcStrategyId>0},hasUidLegalConfig:function(){return this.hasUidColumn}},created:function(){this.refresh()}},f=h,g=a("2877"),b=Object(g["a"])(f,m,d,!1,null,"8259e7b6",null),I=b.exports,w={name:"tables",components:{DbReplicationConfig:I},props:{dbName:String,dbNames:Array,srcRegion:String,dstRegion:String,tableData:Array,dataLoading:Boolean},emits:["updated"],data:function(){return{selectedRow:{},action:null,actionTitleMap:new Map([["create","新增 表同步"],["edit","更新 表同步"],["delete","⚠️删除 表同步"]]),editModal:{open:!1},columns:[{title:"表名",key:"config",minWidth:300,render:function(e,t){var a=t.row;return e("div",a.config.logicTable)}},{title:"过滤规则",key:"filterTypes",minWidth:100,render:function(e,t){var a=t.row,r=a.config.rowsFilterId,i=a.config.colsFilterId;return r||i?e("div",[r&&e("Tag",{props:{color:"blue"}},"行过滤"),i&&e("Tag",{props:{color:"green"}},"字段过滤")]):e("Tag",{props:{color:"red"}},"无")}},{title:"操作",minWidth:100,slot:"action",align:"center",fixed:"right"}]}},methods:{goToInsertConfig:function(){var e=this;return Object(n["a"])(Object(s["a"])().mark((function t(){return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:e.selectedRow=null,e.action=I.FORM_ACTION_OPTION.CREATE,e.editModal.open=!0;case 3:case"end":return t.stop()}}),t)})))()},goToUpdateConfig:function(e,t){var a=this;return Object(n["a"])(Object(s["a"])().mark((function t(){return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:a.selectedRow=e,a.action=I.FORM_ACTION_OPTION.EDIT,a.editModal.open=!0;case 3:case"end":return t.stop()}}),t)})))()},goToDeleteConfig:function(e,t){var a=this;return Object(n["a"])(Object(s["a"])().mark((function t(){return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:a.selectedRow=e,a.action=I.FORM_ACTION_OPTION.DELETE,a.editModal.open=!0;case 3:case"end":return t.stop()}}),t)})))()},finishConfig:function(){this.selectedRow=null,this.editModal.open=!1,this.$emit("updated")}},computed:{actionTitle:function(){return this.actionTitleMap.get(this.action)}},created:function(){}},v=w,C=Object(g["a"])(v,l,c,!1,null,"6250ec54",null),y=C.exports,x=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{style:{padding:"1px 1px",height:"100%"}},[a("Collapse",{model:{value:e.value,callback:function(t){e.value=t},expression:"value"}},e._l(e.mhaReplications,(function(t,r){return a("Panel",{key:t.srcMha.name+"->"+t.dstMha.name,attrs:{name:String(r)},scopedSlots:e._u([{key:"content",fn:function(){return[a("Button",{staticStyle:{"margin-bottom":"10px"},attrs:{icon:"ios-open-outline"},on:{click:function(t){return e.openModal(r)}}},[e._v(" 打开详情")]),a("mha-db-replication-panel",{attrs:{"mha-replication":t}}),a("Modal",{attrs:{width:"1500px","footer-hide":!0},model:{value:e.openDetailModal[r],callback:function(t){e.$set(e.openDetailModal,r,t)},expression:"openDetailModal[index]"}},[e.openDetailModal[r]?a("drc-build-v2",{ref:"dbReplicationConfigComponent",refInFor:!0,attrs:{"src-mha-name":t.srcMha.name,"src-dc":t.srcMha.dcName,"dst-mha-name":t.dstMha.name,"dst-dc":t.dstMha.dcName}}):e._e()],1)]},proxy:!0}],null,!0)},[e._v(" "+e._s(t.srcMha.name+" -> "+t.dstMha.name+" ------ ["+[t.mhaDbReplications.length]+"DB]")+" ")])})),1),a("br"),a("Button",{attrs:{type:"primary",icon:"md-sync"},on:{click:e.goToSwitchAppliers}},[e._v(" 切换Applier生效配置 ")])],1)},R=[],F=(a("cb29"),a("d81d"),function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",[e.mhaReplication.mhaApplierDto?e._e():a("Table",{attrs:{stripe:"",border:"",columns:e.columns,data:e.mhaDbReplications}}),e.mhaReplication.mhaApplierDto?a("Table",{attrs:{stripe:"",border:"",columns:e.mhaColumns,data:[e.mhaReplication]}}):e._e()],1)}),P=[],k=(a("4de4"),a("159b"),a("a3b8")),M=a.n(k),D={name:"mhaDbReplicationPanel",props:{mhaReplication:{}},data:function(){var e=this;return{mhaDbReplications:this.mhaReplication.mhaDbReplications,value:["1"],delayDataLoading:!1,columns:[{title:"类型",width:80,render:function(t,a){var r=a.row,i="none",o="error",s=!1;switch(r.transmissionType){case"simplex":i="单",o="info";break;case"duplex":i="双",o="success";break;default:i="无",s=!0;break}return t("Button",{props:{type:o,size:"small",disabled:s},on:{click:function(){e.showModal(r)}}},i)}},{title:"延迟",key:"drcStatus",width:100,align:"center",renderHeader:function(t,a){return t("span",[t("span","延迟"),e.replicationIds&&0!==e.replicationIds.length&&t("Button",{on:{click:function(){var t=Object(n["a"])(Object(s["a"])().mark((function t(){return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.getDelay();case 2:case"end":return t.stop()}}),t)})));function a(){return t.apply(this,arguments)}return a}()},props:{loading:e.delayDataLoading,size:"small",shape:"circle",type:"default",icon:"md-refresh"}})])},render:function(e,t){var a,r,i=t.row;return!0===i.drcStatus?null!=i.delay?(r=M()(i.delay,{compact:!0}),a=i.delay>1e4?"warning":"success"):(r="已接入",a="blue"):(r="未接入",a="default"),e("Tag",{props:{color:a}},r)}},{title:"DB 名",key:"srcDbName",render:function(e,t){return e("p",t.row.src.dbName)}},{title:"applier",key:"srcDbName",render:function(e,t){return e("p",t.row.dbApplierDto?t.row.dbApplierDto.ips.join(", "):null)}}],mhaColumns:[{title:"延迟",key:"drcStatus",width:100,align:"center",renderHeader:function(t,a){return t("span",[t("span","延迟"),e.mhaReplication.mhaApplierDto.ips&&t("Button",{on:{click:function(){var t=Object(n["a"])(Object(s["a"])().mark((function t(){return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.getMhaDelay();case 2:case"end":return t.stop()}}),t)})));function a(){return t.apply(this,arguments)}return a}()},props:{loading:e.delayDataLoading,size:"small",shape:"circle",type:"default",icon:"md-refresh"}})])},render:function(e,t){var a,r,i=t.row;return i.mhaApplierDto.ips?null!=i.delay?(r=M()(i.delay,{compact:!0}),a=i.delay>1e4?"warning":"success"):(r="已接入",a="blue"):(r="未接入",a="default"),e("Tag",{props:{color:a}},r)}},{title:"类型",width:100,key:"",render:function(e,t){return e("p","mha 同步")}},{title:"applier",key:"",render:function(e,t){return e("p",t.row.mhaApplierDto.ips.join(","))}},{title:"initGtid",key:"",render:function(e,t){return e("p",t.row.mhaApplierDto.gtidInit)}}]}},methods:{showModal:function(e){this.$Message.info("还未上线，敬请期待")},getDelay:function(){var e=this;return Object(n["a"])(Object(s["a"])().mark((function t(){return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(0!==e.replicationIds.length){t.next=3;break}return console.log("skip delay search"),t.abrupt("return");case 3:e.delayDataLoading=!0,e.axios.post("/api/drc/v2/replication/db/delay",{replicationIds:e.replicationIds}).then((function(t){var a=t.data.data,r=null==a||!Array.isArray(a)||0===a.length;if(!r){var i=new Map(a.map((function(e){return[e.srcMha+"->"+e.dstMha+"->"+e.dbName,e.delay]})));e.mhaDbReplications.forEach((function(t){e.$set(t,"delay",i.get(t.src.mhaName+"->"+t.dst.mhaName+"->"+t.src.dbName))}))}})).catch((function(t){console.log(t),e.$Message.error("查询延迟异常: "+t)})).finally((function(){e.delayDataLoading=!1}));case 5:case"end":return t.stop()}}),t)})))()},getMhaDelay:function(){var e=this;return Object(n["a"])(Object(s["a"])().mark((function t(){var a;return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:a={srcMha:e.mhaReplication.srcMha.name,dstMha:e.mhaReplication.dstMha.name},e.delayDataLoading=!0,e.axios.get("/api/drc/v2/replication/delayByName",{params:a}).then((function(t){var a=t.data.data.delay;e.$set(e.mhaReplication,"delay",a)})).catch((function(t){console.log(t),e.$Message.error("查询 MHA 延迟异常: "+t)})).finally((function(){e.delayDataLoading=!1}));case 3:case"end":return t.stop()}}),t)})))()}},computed:{replicationIds:function(){return this.mhaDbReplications.filter((function(e){return!0===e.drcStatus})).map((function(e){return e.id}))}},created:function(){this.getDelay(),this.getMhaDelay()}},N=D,S=Object(g["a"])(N,F,P,!1,null,"23438636",null),_=S.exports,B=a("471e"),O={name:"mhaReplicationPanel",components:{DrcBuildV2:B["a"],MhaDbReplicationPanel:_},props:{mhaReplications:Array},emits:["updated"],data:function(){return{value:[],openDetailModal:[],dataLoading:!1}},methods:{openModal:function(e){this.$set(this.openDetailModal,e,!0)},goToSwitchAppliers:function(){var e=this;this.$Modal.confirm({title:"切换Applier",content:"<p>请确认</p>",loading:!0,onOk:function(){e.switchAppliers()}})},switchAppliers:function(){var e=this,t=this.getSwitchParams();console.log(t),this.dataLoading=!0,this.axios.post("/api/drc/v2/autoconfig/switchAppliers",t).then((function(t){var a=t.data,r=0===a.status;r?e.$Message.success("提交成功"):e.$Message.warning("提交失败: "+a.message)})).catch((function(t){e.$Message.error("提交异常: "+t)})).finally((function(){e.$Modal.remove(),e.dataLoading=!1,e.$emit("updated")}))},getSwitchParams:function(){return this.mhaReplications.map((function(e){return{srcMhaName:e.srcMha.name,dstMhaName:e.dstMha.name,dbNames:e.mhaDbReplications.map((function(e){return e.src.dbName}))}}))}},created:function(){this.openDetailModal=Array(this.mhaReplications.length).fill(!1),console.log("mhaReplications.length",this.mhaReplications),this.mhaReplications&&1===this.mhaReplications.length&&(this.value=["0"])}},T=O,$=Object(g["a"])(T,x,R,!1,null,"857874c4",null),j=$.exports,A=a("7d78"),L={components:{MhaPreview:A["a"],MhaReplicationPanel:j,tables:y},data:function(){return{createModal:{open:!1},dataLoading:!1,configDataLoading:!1,selectedExistReplication:this.$route.query.srcRegionName+" -> "+this.$route.query.dstRegionName,formItem:{srcRegionName:null,dstRegionName:null},drcConfig:{},meta:{dbName:this.$route.query.dbName,srcRegionName:this.$route.query.srcRegionName,dstRegionName:this.$route.query.dstRegionName,fixDb:this.$route.query.fixDb,regionOptions:[],dbOptions:[],existReplicationRegionOptions:[]}}},methods:{getParams:function(){var e={};return e.dbName=this.meta.dbName,e.srcRegionName=this.meta.srcRegionName,e.dstRegionName=this.meta.dstRegionName,e},getExistDb:function(e){var t=this;return Object(n["a"])(Object(s["a"])().mark((function a(){var r;return Object(s["a"])().wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(!(null===e||null===e.length||e.length<=0)){a.next=2;break}return a.abrupt("return",[]);case 2:return r=t,r.dataLoading=!0,a.next=6,r.axios.get("/api/drc/v2/autoconfig/getExistDb",{params:{dbName:e}}).then((function(e){var t=e.data.data;t?r.meta.dbOptions=t:r.$Message.warning("查询DB失败")})).catch((function(e){r.$Message.error("查询DB异常: "+e)})).finally((function(){r.dataLoading=!1}));case 6:case"end":return a.stop()}}),a)})))()},selectDb:function(){var e=this;return Object(n["a"])(Object(s["a"])().mark((function t(){return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.getExistReplicationRegionOptions();case 2:return t.next=4,e.getDrcConfig();case 4:case"end":return t.stop()}}),t)})))()},getDrcConfig:function(){var e=this;return Object(n["a"])(Object(s["a"])().mark((function t(){var a;return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.createModal.open=!1,e.resetPath(),a=e.getParams(),e.drcConfig={},a.dbName){t.next=7;break}return e.$Message.warning("请先填写数据库"),t.abrupt("return");case 7:if(a.srcRegionName&&a.dstRegionName){t.next=9;break}return t.abrupt("return");case 9:if(a.srcRegionName!==a.dstRegionName){t.next=11;break}return t.abrupt("return");case 11:return e.configDataLoading=!0,t.next=14,e.axios.get("/api/drc/v2/autoconfig/getDbDrcConfig",{params:{dbName:a.dbName,srcRegionName:a.srcRegionName,dstRegionName:a.dstRegionName}}).then((function(t){var a=t.data.data,r=a&&0===t.data.status;r?(e.drcConfig=a,e.$Message.success("查询DRC配置成功 ")):e.$Message.warning("查询失败："+t.data.message)})).catch((function(t){e.$Message.error("查询异常: "+t)})).finally((function(){e.configDataLoading=!1}));case 14:case"end":return t.stop()}}),t)})))()},afterSelectExistReplication:function(){var e=this;return Object(n["a"])(Object(s["a"])().mark((function t(){var a;return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:console.log("afterSelectExistReplication ",e.selectedExistReplication),a=e.selectedExistReplication.split("->"),e.meta.srcRegionName=a[0].trim(),e.meta.dstRegionName=a[1].trim(),e.getDrcConfig();case 5:case"end":return t.stop()}}),t)})))()},getExistReplicationRegionOptions:function(){var e=this;return Object(n["a"])(Object(s["a"])().mark((function t(){var a,r;return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return a=e,a.dataLoading=!0,a.meta.existReplicationRegionOptions=[],r=e.getParams(),t.next=6,a.axios.get("/api/drc/v2/autoconfig/getExistDbReplicationDirections",{params:{dbName:r.dbName}}).then((function(e){var t=e.data.data,r=t&&0===e.data.status;r?(a.meta.existReplicationRegionOptions=t,a.meta.existReplicationRegionOptions.length>0&&a.$Message.success("查询到 "+a.meta.existReplicationRegionOptions.length+" 个可选同步方向")):(a.meta.srcRegionName=null,a.meta.dstRegionName=null,a.$Message.warning("查询可选地域失败"))})).catch((function(e){a.$Message.error("查询可选地域失败: "+e)})).finally((function(){a.dataLoading=!1}));case 6:case"end":return t.stop()}}),t)})))()},goToCreateReplication:function(){var e=this;return Object(n["a"])(Object(s["a"])().mark((function t(){return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:e.createModal.open=!0;case 1:case"end":return t.stop()}}),t)})))()},resetPath:function(){this.$router.replace({query:{dbName:this.meta.dbName,srcRegionName:this.meta.srcRegionName,dstRegionName:this.meta.dstRegionName,fixDb:this.meta.fixDb}}).catch((function(){}))},flattenObj:function(e){var t={};for(var a in e)if("object"!==Object(o["a"])(e[a])||Array.isArray(e[a]))t[a]=e[a];else{var r=this.flattenObj(e[a]);for(var i in r)t[a+"."+i]=r[i]}return t}},computed:{},created:function(){var e=this;this.axios.get("/api/drc/v2/permission/meta/mhaReplication/modify").then((function(t){403!==t.data.status?e.meta.dbName&&(e.getExistReplicationRegionOptions(),e.getDrcConfig()):e.$router.push("/nopermission")}))}},U=L,G=(a("21df"),Object(g["a"])(U,r,i,!1,null,null,null));t["default"]=G.exports},"8dfa":function(e,t,a){}}]);
//# sourceMappingURL=chunk-390c5f98.f61c2ae2.js.map