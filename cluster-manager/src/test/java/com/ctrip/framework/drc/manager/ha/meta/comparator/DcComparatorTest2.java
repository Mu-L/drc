package com.ctrip.framework.drc.manager.ha.meta.comparator;


import com.ctrip.framework.drc.core.entity.Dc;
import com.ctrip.framework.drc.core.transform.DefaultSaxParser;
import org.junit.Assert;
import org.junit.Test;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.xml.sax.SAXException;

import java.io.IOException;

public class DcComparatorTest2 {
    private Logger logger = LoggerFactory.getLogger(getClass());

    String more = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n" +
            "<drc>\n" +
            "    <dc id=\"shaoy\">\n" +
            "        <clusterManager ip=\"10.2.84.122\" port=\"8080\" master=\"true\"/>\n" +
            "        <zkServer address=\"10.2.84.112:2181\"/>\n" +
            "        <dbClusters>\n" +
            "            <dbCluster id=\"integration-test.drcOy\" name=\"integration-test\" mhaName=\"drcOy\" buName=\"BBZ\" org-id=\"3\" appId=\"100024819\">\n" +
            "                <dbs readUser=\"root\" readPassword=\"root\" writeUser=\"root\" writePassword=\"root\" monitorUser=\"root\" monitorPassword=\"root\">\n" +
            "                    <db ip=\"10.2.83.109\" port=\"3306\" master=\"true\" uuid=\"a33ded23-6960-11eb-a8e0-fa163e02998c\"/>\n" +
            "                    <db ip=\"10.2.83.110\" port=\"3306\" master=\"false\" uuid=\"54f651cb-6960-11eb-8861-fa163ec90ff6\"/>\n" +
            "                </dbs>\n" +
            "                <replicator ip=\"10.2.83.105\" port=\"8080\" applierPort=\"8407\" gtidSkip=\"a33ded23-6960-11eb-a8e0-fa163e02998c:1-28218422,da293753-695e-11eb-a4c9-fa163eaa9d69:1-21617323\" master=\"false\"/>\n" +
            "                <applier ip=\"10.2.83.100\" port=\"8080\" targetIdc=\"sharb\" targetMhaName=\"drcRb\" gtidExecuted=\"a33ded23-6960-11eb-a8e0-fa163e02998c:1-101\" master=\"false\" routeInfo=\"PROXY://127.0.0.1:80,PROXY://127.0.0.2:80 PROXYTLS://128.0.0.1:443,PROXYTLS://128.0.0.2:443\"/>\n" +
            "            </dbCluster>\n" +
            "            <dbCluster id=\"integration-test2.drcTestW1\" name=\"integration-test2\" mhaName=\"drcTestW1\" buName=\"FX\" org-id=\"5\" appId=\"100012345\">\n" +
            "                <dbs readUser=\"root\" readPassword=\"root\" writeUser=\"root\" writePassword=\"root\" monitorUser=\"root\" monitorPassword=\"root\">\n" +
            "                    <db ip=\"10.2.83.109\" port=\"3307\" master=\"true\" uuid=\"3c458a5b-128a-11eb-a91a-fa163e02998c\"/>\n" +
            "                </dbs>\n" +
            "                <replicator ip=\"10.2.83.105\" port=\"8080\" applierPort=\"8408\" gtidSkip=\"3c458a5b-128a-11eb-a91a-fa163e02998c:1-7416532,f62377c5-1289-11eb-b456-fa163ec90ff6:1-7555645\" master=\"false\"/>\n" +
            "                <applier ip=\"10.2.83.100\" port=\"8080\" targetIdc=\"sharb\" targetMhaName=\"drcTestW2\" gtidExecuted=\"1a908ac5-9365-11ea-b39d-48df3751c126:20215324519:20215324521-20215324523:20215324525:20215324528-20215324529:20215324531-20215324532:20215324539-20215324542:20215324551:20215324558-20215324559:20215324566:20215324569-20215324570:20215324574-20215324575:20215324582-20215324583:20215324587:20215324589-20215324590:20215324592:20215324594:20215324596-20215324597:20215324601-20215324602:20215324605:20215324607-20215324609:20215324613:20215324616-20215324618:20215324621:20215324624-20215324625:20215324631:20215324633:20215324635:20215324637-20215324641:20215324643-20215324644:20215324646-20215324650:20215324653:20215324660:20215324662:20215324664:20215324666:20215324668:20215324672-20215324673:20215324676-20215324677:20215324679:20215324682-20215324683:20215324691:20215324703-20215324705:20215324712-20215324713:20215324718-20215324719:20215324723-20215324725:20215324729-20215324730:20215324734:20215324736:20215324739-20215324741:20215324743-20215324744:20215324749-20215324752:20215324762:20215324769:20215324772:20215324779:20215324781:20215324783:20215324788-20215324789:20215324791:20215324801:20215324807:20215324812:20215324819:20215324824:20215324826:20215324828:20215324831:20215324834:20215324837:20215324847-20215324851:20215324864-20215324865:20215324881:20215324883-20215324884:20215324886-20215324887:20215324892-20215324893:20215324895:20215324900-20215324901:20215324903-20215324904:20215324909:20215324912:20215324914-20215324915:20215324919-20215324920:20215324924:20215324928-20215324930:20215324932:20215324939:20215324946:20215324954:20215324956:20215324965-20215324966:20215324979:20215324988-20215324989:20215324996-20215324998:20215325000-20215325002:20215325004:20215325010-20215325011:20215325018:20215325022:20215325035-20215325036:20215325046-20215325047:20215325059-20215325060:20215325069:20215325076-20215325077:20215325100:20215325104:20215325108:20215325110:20215325114:20215325122:20215325137:20215325139-20215325140:20215325145:20215325148-20215325149:20215325151-20215325152:20215325162:20215325164:20215325166:20215325170:20215325173-20215325174:20215325180-20215325181:20215325200:20215325206-20215325208:20215325210-20215325211:20215325221-20215325222:20215325226:20215325230:20215325232:20215325240:20215325246-20215325248:20215325254:20215325256:20215325260:20215325263:20215325265:20215325271-20215325272:20215325276-20215325277:20215325284-20215325285:20215325295-20215325296:20215325298-20215325299:20215325309-20215325310:20215325320:20215325322:20215325340:20215325347:20215325349-20215325354:20215325357-20215325358:20215325380:20215325387-20215325390:20215325395-20215325396:20215325432-20215325435:20215325485:20215325601:20215325766:20215325775:20215325831:20215325908:20215326101:20215326120:20215326131:20215326135:20215326231:20215326292:20215326307:20215326445:20215326506:20215326530:20215326695:20215326729:20215326907:20215326925:20215326985:20215327038:20215327162:20215327504:20215327528:20215327644:20215327687:20215327711:20215327724:20215327810:20215327830:20215327837:20215327956:20215327994:20215328009:20215328072:20215328182:20215328207:20215328358:20215328452:20215328457:20215328522:20215328537:20215328633:20215328728:20215328784:20215329010:20215329525:20215329713:20215330187:20215330897:21095766819-21095766861:21095766863:21095766865-21095766866:21095766868-21095766869:21095766871-21095766873:21095766875:21095766878:21095766880-21095766882:21095766886:21095766888-21095766890:21095766895:21095766899-21095766901:21095766903-21095766905:21095766908-21095766910:21095766913:21095766918-21095766921:21095766926:21095766931:21095766933-21095766937:21095766956:21095766961-21095766963:21095766965-21095766967:21095766969-21095766970:21095766972:21095766974:21095766983:21095766988-21095766989:21095766991-21095766992:21095766995-21095766998:21095767004:21095767006:21095767008-21095767009:21095767012-21095767013:21095767015:21095767019-21095767020:21095767024:21095767028:21095767030:21095767041:21095767044:21095767054:21095767056:21095767058:21095767061:21095767065:21095767071-21095767072:21095767074:21095767076-21095767077:21095767081-21095767082:21095767084-21095767085:21095767089:21095767094-21095767095:21095767097-21095767098:21095767100:21095767102-21095767103:21095767109:21095767112-21095767114:21095767117:21095767120:21095767123-21095767128:21095767132-21095767134:21095767136-21095767137:21095767140-21095767143:21095767146:21095767154-21095767155:21095767158:21095767162-21095767163:21095767170-21095767171:21095767177-21095767180:21095767182:21095767186:21095767188:21095767192:21095767198-21095767200:21095767204:21095767206:21095767209-21095767210:21095767217:21095767220-21095767221:21095767232:21095767235-21095767236:21095767239:21095767241-21095767242:21095767250-21095767251:21095767256-21095767258:21095767274:21095767281-21095767282:21095767287-21095767289:21095767300:21095767304:21095767308-21095767309:21095767315:21095767326-21095767327:21095767330:21095767332:21095767334-21095767335:21095767337:21095767342:21095767351:21095767358-21095767360:21095767363-21095767364:21095767380-21095767381:21095767394:21095767407-21095767408:21095767413-21095767414:21095767423-21095767426:21095767437-21095767438:21095767441-21095767442:21095767444-21095767445:21095767447:21095767451-21095767452:21095767456-21095767457:21095767462-21095767463:21095767465-21095767466:21095767474:21095767476:21095767479-21095767482:21095767495:21095767498-21095767499:21095767514:21095767524-21095767526:21095767528:21095767534-21095767535:21095767538:21095767540:21095767545-21095767546:21095767549:21095767558-21095767559:21095767563:21095767566:21095767572-21095767574:21095767576-21095767577:21095767582-21095767583:21095767593:21095767595:21095767597-21095767599:21095767606-21095767607:21095767609-21095767612:21095767629:21095767631-21095767632:21095767642:21095767656:21095767677:21095767685:21095767687:21095767700:21095767702:21095767705:21095767707:21095767709-21095767710:21095767719:21095767722-21095767723:21095767726-21095767727:21095767738-21095767741:21095767752-21095767753:21095767759-21095767761:21095767770:21095767772-21095767774:21095767781-21095767782:21095767787:21095767801:21095767814-21095767815:21095767817:21095767829-21095767831:21095767847:21095767850:21095767853:21095767876:21095767878:21095767886-21095767887:21095767971:21095769176:21095772012:21095772692:21095773156:21095773612:21095774070:21096013297-21096013302:21096013305:21096013308:21096013315-21096013316:21096013322-21096013323:21096013325:21096013327:21096013334:21096013339:21096013344-21096013346:21096013350-21096013351:21096013354:21096013359:21096013362-21096013363:21096013368:21096013370-21096013372:21096013381:21096013385:21096013387:21096013389-21096013390:21096013393:21096013397-21096013398:21096013400-21096013401:21096013410-21096013411:21096013415:21096013417:21096013422-21096013424:21096013427-21096013429:21096013435:21096013437:21096013441:21096013444:21096013452:21096013454-21096013455:21096013457-21096013458:21096013461-21096013463:21096013471:21096013473:21096013477-21096013478:21096013483-21096013485:21096013490:21096013496:21096013500-21096013501:21096013503:21096013505-21096013507:21096013519:21096013521-21096013522:21096013525-21096013527:21096013534-21096013535:21096013537:21096013539:21096013541-21096013543:21096013548-21096013550:21096013553:21096013556-21096013558:21096013560:21096013572:21096013574:21096013576:21096013582:21096013589:21096013600:21096013603-21096013604:21096013612:21096013618:21096013620:21096013639-21096013640:21096013642:21096013646:21096013649:21096013651-21096013654:21096013659:21096013672-21096013673:21096013678:21096013680:21096013685:21096013687:21096013694:21096013703:21096013708:21096013712-21096013713:21096013715:21096013719-21096013720:21096013723:21096013729:21096013731:21096013741:21096013750-21096013753:21096013757-21096013758:21096013760:21096013767:21096013775-21096013776:21096013780-21096013781:21096013785-21096013786:21096013793:21096013795:21096013801-21096013802:21096013804-21096013805:21096013811-21096013812:21096013815:21096013824-21096013825:21096013828:21096013832-21096013833:21096013837:21096013842:21096013847-21096013848:21096013853:21096013859:21096013861:21096013863-21096013866:21096013878-21096013879:21096013882:21096013889-21096013894:21096013904:21096013911:21096013924:21096013930:21096013932:21096013939:21096013942:21096013946:21096013948:21096013950:21096013981:21096013985:21096013992:21096013994:21096013996:21096014004:21096014021:21096014023:21096014027-21096014028:21096014039:21096014042-21096014043:21096014050-21096014051:21096014053-21096014054:21096014064-21096014065:21096014070-21096014071:21096014075:21096014088-21096014090:21096014098-21096014099:21096014109-21096014112:21096014117-21096014118:21096014123-21096014126:21096014128:21096014134:21096014140-21096014142:21096014148:21096014151:21096014154:21096014161:21096014165-21096014167:21096014171:21096014178:21096014182-21096014183:21096014186-21096014187:21096014193:21096014202-21096014203:21096014206:21096014208-21096014209:21096014218:21096014220-21096014222:21096014235-21096014236:21096014240:21096014242,3c458a5b-128a-11eb-a91a-fa163e02998c:1-6514281,f62377c5-1289-11eb-b456-fa163ec90ff6:1-6621795\" master=\"false\"/>\n" +
            "            </dbCluster>\n" +
            "            <dbCluster id=\"integration-test3.mha3308oy\" name=\"integration-test3\" mhaName=\"mha3308oy\" buName=\"BBZ3\" org-id=\"7\" appId=\"100012345\">\n" +
            "                <dbs readUser=\"root\" readPassword=\"root\" writeUser=\"root\" writePassword=\"root\" monitorUser=\"root\" monitorPassword=\"root\">\n" +
            "                    <db ip=\"10.2.83.109\" port=\"3308\" master=\"true\" uuid=\"546e2e47-02fb-11eb-9eb7-fa163e02998c\"/>\n" +
            "                </dbs>\n" +
            "                <replicator ip=\"10.2.83.105\" port=\"8080\" applierPort=\"8409\" gtidSkip=\"546e2e47-02fb-11eb-9eb7-fa163e02998c:1-12707087,5b1ae89c-02fb-11eb-94b9-fa163eaa9d69:1-13137083\" master=\"false\"/>\n" +
            "                <applier ip=\"10.2.83.100\" port=\"8080\" targetIdc=\"sharb\" targetMhaName=\"mha3308rb\" gtidExecuted=\"546e2e47-02fb-11eb-9eb7-fa163e02998c:1-12707173,5b1ae89c-02fb-11eb-94b9-fa163eaa9d69:1-13136994\" master=\"false\"/>\n" +
            "            </dbCluster>\n" +
            "            <dbCluster id=\"testbbzimelongdetailshardbasedb_dalcluster.testbbzimelongdetailoy\" name=\"testbbzimelongdetailshardbasedb_dalcluster\" mhaName=\"testbbzimelongdetailoy\" buName=\"BBZ\" org-id=\"3\" appId=\"100045678\">\n" +
            "                <dbs readUser=\"root\" readPassword=\"root\" writeUser=\"root\" writePassword=\"root\" monitorUser=\"root\" monitorPassword=\"root\">\n" +
            "                    <db ip=\"10.2.83.109\" port=\"3321\" master=\"true\" uuid=\"f0848c48-c355-11eb-85fc-fa163e02998c\"/>\n" +
            "                </dbs>\n" +
            "                <replicator ip=\"10.2.83.105\" port=\"8080\" applierPort=\"8410\" gtidSkip=\"1aae72ca-c357-11eb-a16a-fa163eaa9d69:1-8\" master=\"false\"/>\n" +
            "                <applier ip=\"10.2.83.100\" port=\"8080\" targetIdc=\"sharb\" targetMhaName=\"testbbzimelongdetailshard1rb\" gtidExecuted=\"f0848c48-c355-11eb-85fc-fa163e02998c:1-9\" master=\"false\" includedDbs=\"drcmonitordb,db1\"/>\n" +
            "                <applier ip=\"10.2.83.100\" port=\"8080\" targetIdc=\"sharb\" targetMhaName=\"testbbzimelongdetailshard2rb\" gtidExecuted=\"1aae72ca-c357-11eb-a16a-fa163eaa9d69:1-3610,f0848c48-c355-11eb-85fc-fa163e02998c:1-3629\" master=\"false\" includedDbs=\"drcmonitordb,db2\"/>\n" +
            "            </dbCluster>\n" +
            "        </dbClusters>\n" +
            "    </dc>\n" +
            "</drc>";
    String less = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n" +
            "<drc>\n" +
            "    <dc id=\"shaoy\">\n" +
            "        <clusterManager ip=\"10.2.84.122\" port=\"8080\" master=\"true\"/>\n" +
            "        <zkServer address=\"10.2.84.112:2181\"/>\n" +
            "        <dbClusters>\n" +
            "            <dbCluster id=\"integration-test.drcOy\" name=\"integration-test\" mhaName=\"drcOy\" buName=\"BBZ\" org-id=\"3\" appId=\"100024819\">\n" +
            "                <dbs readUser=\"root\" readPassword=\"root\" writeUser=\"root\" writePassword=\"root\" monitorUser=\"root\" monitorPassword=\"root\">\n" +
            "                    <db ip=\"10.2.83.109\" port=\"3306\" master=\"true\" uuid=\"a33ded23-6960-11eb-a8e0-fa163e02998c\"/>\n" +
            "                    <db ip=\"10.2.83.110\" port=\"3306\" master=\"false\" uuid=\"54f651cb-6960-11eb-8861-fa163ec90ff6\"/>\n" +
            "                </dbs>\n" +
            "                <replicator ip=\"10.2.83.105\" port=\"8080\" applierPort=\"8407\" gtidSkip=\"a33ded23-6960-11eb-a8e0-fa163e02998c:1-28218422,da293753-695e-11eb-a4c9-fa163eaa9d69:1-21617323\" master=\"false\"/>\n" +
            "                <applier ip=\"10.2.83.100\" port=\"8080\" targetIdc=\"sharb\" targetMhaName=\"drcRb\" gtidExecuted=\"a33ded23-6960-11eb-a8e0-fa163e02998c:1-101\" master=\"false\" routeInfo=\"PROXY://127.0.0.1:80,PROXY://127.0.0.2:80 PROXYTLS://128.0.0.1:443,PROXYTLS://128.0.0.2:443\"/>\n" +
            "            </dbCluster>\n" +
            "            <dbCluster id=\"integration-test2.drcTestW1\" name=\"integration-test2\" mhaName=\"drcTestW1\" buName=\"FX\" org-id=\"5\" appId=\"100012345\">\n" +
            "                <dbs readUser=\"root\" readPassword=\"root\" writeUser=\"root\" writePassword=\"root\" monitorUser=\"root\" monitorPassword=\"root\">\n" +
            "                    <db ip=\"10.2.83.109\" port=\"3307\" master=\"true\" uuid=\"3c458a5b-128a-11eb-a91a-fa163e02998c\"/>\n" +
            "                </dbs>\n" +
            "                <replicator ip=\"10.2.83.105\" port=\"8080\" applierPort=\"8408\" gtidSkip=\"3c458a5b-128a-11eb-a91a-fa163e02998c:1-7416532,f62377c5-1289-11eb-b456-fa163ec90ff6:1-7555645\" master=\"false\"/>\n" +
            "                <applier ip=\"10.2.83.100\" port=\"8080\" targetIdc=\"sharb\" targetMhaName=\"drcTestW2\" gtidExecuted=\"1a908ac5-9365-11ea-b39d-48df3751c126:20215324519:20215324521-20215324523:20215324525:20215324528-20215324529:20215324531-20215324532:20215324539-20215324542:20215324551:20215324558-20215324559:20215324566:20215324569-20215324570:20215324574-20215324575:20215324582-20215324583:20215324587:20215324589-20215324590:20215324592:20215324594:20215324596-20215324597:20215324601-20215324602:20215324605:20215324607-20215324609:20215324613:20215324616-20215324618:20215324621:20215324624-20215324625:20215324631:20215324633:20215324635:20215324637-20215324641:20215324643-20215324644:20215324646-20215324650:20215324653:20215324660:20215324662:20215324664:20215324666:20215324668:20215324672-20215324673:20215324676-20215324677:20215324679:20215324682-20215324683:20215324691:20215324703-20215324705:20215324712-20215324713:20215324718-20215324719:20215324723-20215324725:20215324729-20215324730:20215324734:20215324736:20215324739-20215324741:20215324743-20215324744:20215324749-20215324752:20215324762:20215324769:20215324772:20215324779:20215324781:20215324783:20215324788-20215324789:20215324791:20215324801:20215324807:20215324812:20215324819:20215324824:20215324826:20215324828:20215324831:20215324834:20215324837:20215324847-20215324851:20215324864-20215324865:20215324881:20215324883-20215324884:20215324886-20215324887:20215324892-20215324893:20215324895:20215324900-20215324901:20215324903-20215324904:20215324909:20215324912:20215324914-20215324915:20215324919-20215324920:20215324924:20215324928-20215324930:20215324932:20215324939:20215324946:20215324954:20215324956:20215324965-20215324966:20215324979:20215324988-20215324989:20215324996-20215324998:20215325000-20215325002:20215325004:20215325010-20215325011:20215325018:20215325022:20215325035-20215325036:20215325046-20215325047:20215325059-20215325060:20215325069:20215325076-20215325077:20215325100:20215325104:20215325108:20215325110:20215325114:20215325122:20215325137:20215325139-20215325140:20215325145:20215325148-20215325149:20215325151-20215325152:20215325162:20215325164:20215325166:20215325170:20215325173-20215325174:20215325180-20215325181:20215325200:20215325206-20215325208:20215325210-20215325211:20215325221-20215325222:20215325226:20215325230:20215325232:20215325240:20215325246-20215325248:20215325254:20215325256:20215325260:20215325263:20215325265:20215325271-20215325272:20215325276-20215325277:20215325284-20215325285:20215325295-20215325296:20215325298-20215325299:20215325309-20215325310:20215325320:20215325322:20215325340:20215325347:20215325349-20215325354:20215325357-20215325358:20215325380:20215325387-20215325390:20215325395-20215325396:20215325432-20215325435:20215325485:20215325601:20215325766:20215325775:20215325831:20215325908:20215326101:20215326120:20215326131:20215326135:20215326231:20215326292:20215326307:20215326445:20215326506:20215326530:20215326695:20215326729:20215326907:20215326925:20215326985:20215327038:20215327162:20215327504:20215327528:20215327644:20215327687:20215327711:20215327724:20215327810:20215327830:20215327837:20215327956:20215327994:20215328009:20215328072:20215328182:20215328207:20215328358:20215328452:20215328457:20215328522:20215328537:20215328633:20215328728:20215328784:20215329010:20215329525:20215329713:20215330187:20215330897:21095766819-21095766861:21095766863:21095766865-21095766866:21095766868-21095766869:21095766871-21095766873:21095766875:21095766878:21095766880-21095766882:21095766886:21095766888-21095766890:21095766895:21095766899-21095766901:21095766903-21095766905:21095766908-21095766910:21095766913:21095766918-21095766921:21095766926:21095766931:21095766933-21095766937:21095766956:21095766961-21095766963:21095766965-21095766967:21095766969-21095766970:21095766972:21095766974:21095766983:21095766988-21095766989:21095766991-21095766992:21095766995-21095766998:21095767004:21095767006:21095767008-21095767009:21095767012-21095767013:21095767015:21095767019-21095767020:21095767024:21095767028:21095767030:21095767041:21095767044:21095767054:21095767056:21095767058:21095767061:21095767065:21095767071-21095767072:21095767074:21095767076-21095767077:21095767081-21095767082:21095767084-21095767085:21095767089:21095767094-21095767095:21095767097-21095767098:21095767100:21095767102-21095767103:21095767109:21095767112-21095767114:21095767117:21095767120:21095767123-21095767128:21095767132-21095767134:21095767136-21095767137:21095767140-21095767143:21095767146:21095767154-21095767155:21095767158:21095767162-21095767163:21095767170-21095767171:21095767177-21095767180:21095767182:21095767186:21095767188:21095767192:21095767198-21095767200:21095767204:21095767206:21095767209-21095767210:21095767217:21095767220-21095767221:21095767232:21095767235-21095767236:21095767239:21095767241-21095767242:21095767250-21095767251:21095767256-21095767258:21095767274:21095767281-21095767282:21095767287-21095767289:21095767300:21095767304:21095767308-21095767309:21095767315:21095767326-21095767327:21095767330:21095767332:21095767334-21095767335:21095767337:21095767342:21095767351:21095767358-21095767360:21095767363-21095767364:21095767380-21095767381:21095767394:21095767407-21095767408:21095767413-21095767414:21095767423-21095767426:21095767437-21095767438:21095767441-21095767442:21095767444-21095767445:21095767447:21095767451-21095767452:21095767456-21095767457:21095767462-21095767463:21095767465-21095767466:21095767474:21095767476:21095767479-21095767482:21095767495:21095767498-21095767499:21095767514:21095767524-21095767526:21095767528:21095767534-21095767535:21095767538:21095767540:21095767545-21095767546:21095767549:21095767558-21095767559:21095767563:21095767566:21095767572-21095767574:21095767576-21095767577:21095767582-21095767583:21095767593:21095767595:21095767597-21095767599:21095767606-21095767607:21095767609-21095767612:21095767629:21095767631-21095767632:21095767642:21095767656:21095767677:21095767685:21095767687:21095767700:21095767702:21095767705:21095767707:21095767709-21095767710:21095767719:21095767722-21095767723:21095767726-21095767727:21095767738-21095767741:21095767752-21095767753:21095767759-21095767761:21095767770:21095767772-21095767774:21095767781-21095767782:21095767787:21095767801:21095767814-21095767815:21095767817:21095767829-21095767831:21095767847:21095767850:21095767853:21095767876:21095767878:21095767886-21095767887:21095767971:21095769176:21095772012:21095772692:21095773156:21095773612:21095774070:21096013297-21096013302:21096013305:21096013308:21096013315-21096013316:21096013322-21096013323:21096013325:21096013327:21096013334:21096013339:21096013344-21096013346:21096013350-21096013351:21096013354:21096013359:21096013362-21096013363:21096013368:21096013370-21096013372:21096013381:21096013385:21096013387:21096013389-21096013390:21096013393:21096013397-21096013398:21096013400-21096013401:21096013410-21096013411:21096013415:21096013417:21096013422-21096013424:21096013427-21096013429:21096013435:21096013437:21096013441:21096013444:21096013452:21096013454-21096013455:21096013457-21096013458:21096013461-21096013463:21096013471:21096013473:21096013477-21096013478:21096013483-21096013485:21096013490:21096013496:21096013500-21096013501:21096013503:21096013505-21096013507:21096013519:21096013521-21096013522:21096013525-21096013527:21096013534-21096013535:21096013537:21096013539:21096013541-21096013543:21096013548-21096013550:21096013553:21096013556-21096013558:21096013560:21096013572:21096013574:21096013576:21096013582:21096013589:21096013600:21096013603-21096013604:21096013612:21096013618:21096013620:21096013639-21096013640:21096013642:21096013646:21096013649:21096013651-21096013654:21096013659:21096013672-21096013673:21096013678:21096013680:21096013685:21096013687:21096013694:21096013703:21096013708:21096013712-21096013713:21096013715:21096013719-21096013720:21096013723:21096013729:21096013731:21096013741:21096013750-21096013753:21096013757-21096013758:21096013760:21096013767:21096013775-21096013776:21096013780-21096013781:21096013785-21096013786:21096013793:21096013795:21096013801-21096013802:21096013804-21096013805:21096013811-21096013812:21096013815:21096013824-21096013825:21096013828:21096013832-21096013833:21096013837:21096013842:21096013847-21096013848:21096013853:21096013859:21096013861:21096013863-21096013866:21096013878-21096013879:21096013882:21096013889-21096013894:21096013904:21096013911:21096013924:21096013930:21096013932:21096013939:21096013942:21096013946:21096013948:21096013950:21096013981:21096013985:21096013992:21096013994:21096013996:21096014004:21096014021:21096014023:21096014027-21096014028:21096014039:21096014042-21096014043:21096014050-21096014051:21096014053-21096014054:21096014064-21096014065:21096014070-21096014071:21096014075:21096014088-21096014090:21096014098-21096014099:21096014109-21096014112:21096014117-21096014118:21096014123-21096014126:21096014128:21096014134:21096014140-21096014142:21096014148:21096014151:21096014154:21096014161:21096014165-21096014167:21096014171:21096014178:21096014182-21096014183:21096014186-21096014187:21096014193:21096014202-21096014203:21096014206:21096014208-21096014209:21096014218:21096014220-21096014222:21096014235-21096014236:21096014240:21096014242,3c458a5b-128a-11eb-a91a-fa163e02998c:1-6514281,f62377c5-1289-11eb-b456-fa163ec90ff6:1-6621795\" master=\"false\"/>\n" +
            "            </dbCluster>\n" +
            "            <dbCluster id=\"integration-test3.mha3308oy\" name=\"integration-test3\" mhaName=\"mha3308oy\" buName=\"BBZ3\" org-id=\"7\" appId=\"100012345\">\n" +
            "                <dbs readUser=\"root\" readPassword=\"root\" writeUser=\"root\" writePassword=\"root\" monitorUser=\"root\" monitorPassword=\"root\">\n" +
            "                    <db ip=\"10.2.83.109\" port=\"3308\" master=\"true\" uuid=\"546e2e47-02fb-11eb-9eb7-fa163e02998c\"/>\n" +
            "                </dbs>\n" +
            "                <replicator ip=\"10.2.83.105\" port=\"8080\" applierPort=\"8409\" gtidSkip=\"546e2e47-02fb-11eb-9eb7-fa163e02998c:1-12707087,5b1ae89c-02fb-11eb-94b9-fa163eaa9d69:1-13137083\" master=\"false\"/>\n" +
            "                <applier ip=\"10.2.83.100\" port=\"8080\" targetIdc=\"sharb\" targetMhaName=\"mha3308rb\" gtidExecuted=\"546e2e47-02fb-11eb-9eb7-fa163e02998c:1-12707173,5b1ae89c-02fb-11eb-94b9-fa163eaa9d69:1-13136994\" master=\"false\"/>\n" +
            "            </dbCluster>\n" +
            "            <dbCluster id=\"testbbzimelongdetailshardbasedb_dalcluster.testbbzimelongdetailoy\" name=\"testbbzimelongdetailshardbasedb_dalcluster\" mhaName=\"testbbzimelongdetailoy\" buName=\"BBZ\" org-id=\"3\" appId=\"100045678\">\n" +
            "                <dbs readUser=\"root\" readPassword=\"root\" writeUser=\"root\" writePassword=\"root\" monitorUser=\"root\" monitorPassword=\"root\">\n" +
            "                    <db ip=\"10.2.83.109\" port=\"3321\" master=\"true\" uuid=\"f0848c48-c355-11eb-85fc-fa163e02998c\"/>\n" +
            "                </dbs>\n" +
            "                <replicator ip=\"10.2.83.105\" port=\"8080\" applierPort=\"8410\" gtidSkip=\"1aae72ca-c357-11eb-a16a-fa163eaa9d69:1-8\" master=\"false\"/>\n" +
            "                <applier ip=\"10.2.83.100\" port=\"8080\" targetIdc=\"sharb\" targetMhaName=\"testbbzimelongdetailshard1rb\" gtidExecuted=\"f0848c48-c355-11eb-85fc-fa163e02998c:1-9\" master=\"false\" includedDbs=\"drcmonitordb,db1\"/>\n" +
            "            </dbCluster>\n" +
            "        </dbClusters>\n" +
            "    </dc>\n" +
            "</drc>";

    @Test
    public void testDeleteApplierForNewCluster() throws IOException, SAXException {

        Dc moreDc = DefaultSaxParser.parse(more).getDcs().get("shaoy");
        Dc lessDc = DefaultSaxParser.parse(less).getDcs().get("shaoy");
        DcComparator dcComparator = new DcComparator(moreDc, lessDc);
        dcComparator.compare();
        logger.info("add-{}, modified-{}, deleted-{}", dcComparator.getAdded(), dcComparator.getMofified(), dcComparator.getRemoved());
        Assert.assertEquals(1, dcComparator.getMofified().size());
        ClusterComparator clusterComparator = (ClusterComparator) dcComparator.getMofified().iterator().next();
        logger.info("ClusterComparator: {}", clusterComparator);
        Assert.assertEquals(0, clusterComparator.getReplicatorComparator().totalChangedCount());
        Assert.assertEquals(0, clusterComparator.getDbComparator().totalChangedCount());
        ApplierComparator applierComparator = clusterComparator.getApplierComparator();
        logger.info("ApplierComparator: {}", applierComparator);
        Assert.assertEquals(1, applierComparator.totalChangedCount());
        Assert.assertEquals(1, applierComparator.getRemoved().size());
    }

    @Test
    public void testAddApplierForNewCluster() throws IOException, SAXException {
        Dc moreDc = DefaultSaxParser.parse(more).getDcs().get("shaoy");
        Dc lessDc = DefaultSaxParser.parse(less).getDcs().get("shaoy");
        DcComparator dcComparator = new DcComparator(lessDc, moreDc);
        dcComparator.compare();
        logger.info("add-{}, modified-{}, deleted-{}", dcComparator.getAdded(), dcComparator.getMofified(), dcComparator.getRemoved());
        Assert.assertEquals(1, dcComparator.getMofified().size());
        ClusterComparator clusterComparator = (ClusterComparator) dcComparator.getMofified().iterator().next();
        logger.info("ClusterComparator: {}", clusterComparator);
        Assert.assertEquals(0, clusterComparator.getReplicatorComparator().totalChangedCount());
        Assert.assertEquals(0, clusterComparator.getDbComparator().totalChangedCount());
        ApplierComparator applierComparator = clusterComparator.getApplierComparator();
        logger.info("ApplierComparator: {}", applierComparator);
        Assert.assertEquals(1, applierComparator.totalChangedCount());
        Assert.assertEquals(1, applierComparator.getAdded().size());
    }
}